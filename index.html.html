<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* ===== CSSå¤‰æ•° ===== */
    :root {
      --color-saturday-bg: #DBEAFE;
      --color-sunday-bg:   #FCE7F3;
      --color-requested-bg:#E5E7EB;
      --color-confirmed-bg:#FFFFFF;
      --color-editing-bg:  #FEF08A;
      --color-over:        #FF4D6D;
      --color-under:       #4DABF7;
      --color-ok:          #51CF66;
      --color-overage-cell:#FF4D6D;
      --color-tab-active:  #3B82F6;
      --color-tab-bg:      #F3F4F6;
      --color-border:      #D1D5DB;
      --color-text:        #1F2937;
      --color-muted:       #6B7280;
      --color-white:       #FFFFFF;
      --color-primary:     #3B82F6;
      --color-primary-hover:#2563EB;
      --color-danger:      #EF4444;
      --color-success:     #10B981;
      --radius:            6px;
      --shadow:            0 1px 3px rgba(0,0,0,0.12);
    }

    /* ===== ãƒªã‚»ãƒƒãƒˆ ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      font-size: 14px;
      color: var(--color-text);
      background: #F9FAFB;
      min-height: 100vh;
    }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid var(--color-border); padding: 6px 8px; text-align: left; vertical-align: middle; }
    th { background: #F3F4F6; font-weight: 600; }
    input[type="text"], input[type="number"], input[type="month"], input[type="time"], select {
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 5px 8px;
      font-size: 13px;
      background: var(--color-white);
      color: var(--color-text);
      outline: none;
    }
    input:focus, select:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
    button {
      border: none;
      border-radius: var(--radius);
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-primary   { background: var(--color-primary); color: #fff; }
    .btn-primary:hover { background: var(--color-primary-hover); }
    .btn-secondary { background: #E5E7EB; color: var(--color-text); }
    .btn-secondary:hover { background: #D1D5DB; }
    .btn-danger    { background: var(--color-danger); color: #fff; }
    .btn-danger:hover { background: #DC2626; }
    .btn-success   { background: var(--color-success); color: #fff; }
    .btn-success:hover { background: #059669; }
    .btn-excel     { background: #217346; color: #fff; }
    .btn-excel:hover { background: #1a5c38; }

    /* ===== ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒŠãƒ¼ ===== */
    #alert-banner {
      background: #FEE2E2;
      color: #B91C1C;
      padding: 10px 16px;
      font-weight: bold;
      border-bottom: 2px solid #F87171;
      position: sticky;
      top: 0;
      z-index: 200;
    }
    #alert-banner.hidden { display: none; }

    /* ===== ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ===== */
    .tab-nav {
      display: flex;
      background: var(--color-white);
      border-bottom: 2px solid var(--color-border);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }
    .tab-btn {
      padding: 12px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      border-radius: 0;
      font-size: 13px;
      font-weight: 600;
      color: var(--color-muted);
      cursor: pointer;
      white-space: nowrap;
    }
    .tab-btn:hover { color: var(--color-primary); background: #EFF6FF; }
    .tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }

    /* ===== ã‚¿ãƒ–ãƒ‘ãƒãƒ« ===== */
    .tab-panel { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; }
    .tab-panel.active { display: block; }

    /* ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€š ===== */
    .section-header { margin-bottom: 16px; }
    .section-header h2 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .section-header p { color: var(--color-muted); font-size: 13px; }
    .card {
      background: var(--color-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h3 { font-size: 15px; font-weight: 700; margin-bottom: 14px; color: var(--color-text); }
    .form-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; margin-bottom: 12px; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: 12px; font-weight: 600; color: var(--color-muted); }
    .form-group input, .form-group select { min-width: 140px; }

    /* ===== ã‚¹ã‚¿ãƒƒãƒ•åç°¿ ===== */
    #roster-tbody td { padding: 6px 8px; }
    .roster-actions { display: flex; gap: 6px; }

    /* ===== ã‚·ãƒ•ãƒˆãƒ•ã‚©ãƒ¼ãƒ  ===== */
    .form-meta { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; margin-bottom: 16px; }
    .shift-form-table th { white-space: nowrap; font-size: 12px; }
    .shift-form-table td { padding: 4px 6px; }
    .shift-form-table select { font-size: 12px; padding: 3px 4px; }
    tr.day-saturday { background-color: var(--color-saturday-bg); }
    tr.day-holiday  { background-color: var(--color-sunday-bg); }

    /* ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ===== */
    .dashboard-meta { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 20px; }
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 12px; margin-bottom: 12px; }
    .settings-grid .form-group input { width: 100%; }
    .day-hours-row {
      display: flex; align-items: center; gap: 10px;
      padding: 6px 10px; margin-bottom: 6px; border-radius: 6px;
      border: 1px solid #D1D5DB; background: #F9FAFB; font-size: 13px;
    }
    .day-hours-row.row-weekday  { background: #F0FDF4; border-color: #6EE7B7; }
    .day-hours-row.row-saturday { background: var(--color-saturday-bg); border-color: #93C5FD; }
    .day-hours-row.row-sunday   { background: var(--color-sunday-bg);   border-color: #F9A8D4; }
    .day-hours-row .row-label { font-weight: 600; min-width: 90px; }
    .day-hours-row input[type="time"] { font-size: 12px; padding: 3px 6px; border: 1px solid #D1D5DB; border-radius: 4px; width: 90px; }
    .day-hours-row.row-closed { background: #F3F4F6; border-color: #9CA3AF; color: #6B7280; }
    .btn-remove-row { background: none; border: none; color: #9CA3AF; font-size: 16px; cursor: pointer; line-height: 1; padding: 0 4px; }
    .btn-remove-row:hover { color: #EF4444; }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…±é€š */
    .calendar-scroll { overflow-x: auto; }

    /* åˆ†æãƒ†ãƒ¼ãƒ–ãƒ« */
    #analysis-table td:last-child { font-weight: 600; text-align: right; }
    .analysis-value { color: var(--color-primary); }
    .analysis-warn  { color: var(--color-danger); }

    /* ===== ã‚·ãƒ•ãƒˆèª¿æ•´ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆç¸¦=ã‚¹ã‚¿ãƒƒãƒ•ãƒ»æ¨ª=æ—¥ä»˜ï¼‰===== */
    #shift-calendar { min-width: 800px; font-size: 11px; border-collapse: collapse; }
    #shift-calendar th { font-size: 11px; text-align: center; white-space: nowrap; padding: 4px 3px; }
    #shift-calendar td { padding: 2px 3px; vertical-align: top; min-width: 52px; }

    /* æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ */
    .cal-head-date { font-weight: 700; font-size: 12px; }
    .cal-head-dow  { font-size: 10px; }
    .cal-head-hc   { font-size: 10px; font-weight: 700; }
    th.col-sat { background: var(--color-saturday-bg) !important; }
    th.col-hol { background: var(--color-sunday-bg) !important; }

    /* ã‚¹ã‚¿ãƒƒãƒ•ååˆ— */
    .cal-staff-name {
      position: sticky; left: 0; z-index: 10;
      background: #F8FAFC; font-weight: 700; font-size: 12px;
      white-space: nowrap; padding: 4px 8px;
      border-right: 2px solid var(--color-border);
      min-width: 80px;
    }
    .cal-staff-name.monthly-overage { background: #FF4D6D !important; color: #fff !important; }
    .cal-staff-name.weekly-overage  { background: #FBBF24 !important; color: #1F2937 !important; }

    /* ã‚·ãƒ•ãƒˆã‚»ãƒ« */
    .shift-cell {
      background: #fff;
      border-radius: 4px;
      padding: 2px;
      min-height: 44px;
      position: relative;
    }
    /* å¸Œæœ›ã‚ã‚Šãƒ»æœªç¢ºå®š */
    .shift-cell.has-request { background: #E5E7EB; }
    /* ç¢ºå®šæ¸ˆã¿ */
    .shift-cell.confirmed   { background: #D1FAE5; border: 1px solid #6EE7B7; }
    /* åœŸæ›œã‚«ãƒ©ãƒ  */
    td.col-sat { background: var(--color-saturday-bg); }
    td.col-hol { background: var(--color-sunday-bg); }
    /* åœŸæ›œãƒ»æ—¥ç¥ã‚«ãƒ©ãƒ ã®ç¢ºå®šã‚»ãƒ« */
    td.col-sat .shift-cell.confirmed { background: #BAE6FD; border-color: #38BDF8; }
    td.col-hol .shift-cell.confirmed { background: #FBCFE8; border-color: #F472B6; }
    /* ä¼‘ã¿ã‚»ãƒ« */
    .shift-cell.day-off {
      background: #E5E7EB; border: 1px solid #9CA3AF;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 13px; color: #6B7280; letter-spacing: 1px;
    }
    .shift-cell.day-off .shift-request-label,
    .shift-cell.day-off .shift-time-inputs { display: none; }
    .btn-day-off {
      position: absolute; top: 2px; right: 2px;
      font-size: 9px; padding: 1px 4px; line-height: 1.4;
      background: #F3F4F6; border: 1px solid #9CA3AF; color: #6B7280;
      border-radius: 3px; cursor: pointer;
    }
    .btn-day-off:hover { background: #D1D5DB; }
    .shift-cell.day-off .btn-day-off {
      background: #D1D5DB; color: #374151; font-size: 9px;
    }

    .shift-request-label {
      font-size: 10px; color: #6B7280; line-height: 1.2;
      display: block; margin-bottom: 2px;
    }
    .shift-time-inputs {
      display: flex; flex-direction: column; gap: 1px;
    }
    .shift-time-inputs input[type="time"] {
      font-size: 11px; padding: 1px 2px; width: 100%;
      border: 1px solid #D1D5DB; border-radius: 3px;
      background: rgba(255,255,255,0.8);
    }
    .shift-time-inputs input[type="time"]:focus {
      border-color: var(--color-primary);
      background: #FEF08A;
      outline: none;
    }
    /* äººæ•°è¡Œ */
    .hc-row td { text-align: center; font-weight: 700; font-size: 12px; border-top: 2px solid var(--color-border); }
    .hc-label { font-size: 11px; font-weight: 700; white-space: nowrap; padding: 4px 8px;
      position: sticky; left: 0; background: #F8FAFC; border-right: 2px solid var(--color-border); }

    /* ===== ãƒˆãƒ¼ã‚¹ãƒˆ ===== */
    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1F2937;
      color: #fff;
      padding: 10px 18px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 600;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    #toast.show { opacity: 1; }

    /* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ===== */
    @media (max-width: 600px) {
      .tab-btn { padding: 10px 10px; font-size: 11px; }
      .tab-panel { padding: 12px; }
    }
  </style>
</head>
<body>

<!-- ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒŠãƒ¼ -->
<div id="alert-banner" class="hidden"></div>

<!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<nav class="tab-nav">
  <button class="tab-btn active" data-tab="roster">ã‚¹ã‚¿ãƒƒãƒ•åç°¿</button>
  <button class="tab-btn" data-tab="form-first">ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆå‰åŠ 1ã€œ15æ—¥ï¼‰</button>
  <button class="tab-btn" data-tab="form-second">ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆå¾ŒåŠ 16ã€œæœ«æ—¥ï¼‰</button>
  <button class="tab-btn" data-tab="dashboard">ã‚·ãƒ•ãƒˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
</nav>

<!-- ===== Tab 1: ã‚¹ã‚¿ãƒƒãƒ•åç°¿ ===== -->
<div id="panel-roster" class="tab-panel active">
  <div class="section-header">
    <h2>ã‚¹ã‚¿ãƒƒãƒ•åç°¿</h2>
    <p>ã‚¹ã‚¿ãƒƒãƒ•ã®åŸºæœ¬æƒ…å ±ã¨é›‡ç”¨å¥‘ç´„ã‚’ç™»éŒ²ãƒ»ç®¡ç†ã—ã¾ã™ã€‚</p>
  </div>

  <!-- ç®¡ç†è€…ãƒ­ãƒƒã‚¯ -->
  <div class="card" style="margin-bottom:12px;background:#FFF7ED;border:1px solid #FED7AA;">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <span style="font-weight:700;font-size:13px;">ğŸ”’ çµ¦ä¸æƒ…å ±ã®è¡¨ç¤º</span>
      <span id="wage-lock-status" style="font-size:12px;color:var(--color-muted);">éè¡¨ç¤ºï¼ˆâ—â—â—â—ï¼‰</span>
      <input type="password" id="admin-password-input" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:160px;font-size:12px;">
      <button id="wage-toggle-btn" class="btn-secondary" style="font-size:12px;">è¡¨ç¤ºã™ã‚‹</button>
      <span style="font-size:11px;color:var(--color-muted);">åˆæœŸå€¤ï¼šadmin1234</span>
    </div>
    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆè¡¨ç¤ºä¸­ã®ã¿ï¼‰ -->
    <div id="change-password-area" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #FED7AA;align-items:center;gap:8px;flex-wrap:wrap;">
      <span style="font-size:12px;font-weight:600;">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼š</span>
      <input type="password" id="new-password-input" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:160px;font-size:12px;">
      <input type="password" id="new-password-confirm" placeholder="ç¢ºèªï¼ˆã‚‚ã†ä¸€åº¦ï¼‰" style="width:160px;font-size:12px;">
      <button id="change-password-btn" class="btn-primary" style="font-size:12px;">å¤‰æ›´ã™ã‚‹</button>
    </div>
  </div>

  <div class="card">
    <h3>ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ² / ç·¨é›†</h3>
    <form id="roster-form">
      <input type="hidden" id="edit-staff-id">
      <div class="form-row">
        <div class="form-group">
          <label>ã‚¹ã‚¿ãƒƒãƒ•å <span style="color:red">*</span></label>
          <input type="text" id="staff-name" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒ" required>
        </div>
        <div class="form-group">
          <label>é›‡ç”¨å½¢æ…‹</label>
          <select id="employment-type" onchange="RosterModule.onEmploymentTypeChange()">
            <option>æ­£ç¤¾å“¡</option>
            <option>ãƒ‘ãƒ¼ãƒˆ</option>
            <option>ã‚¢ãƒ«ãƒã‚¤ãƒˆ</option>
          </select>
        </div>
        <div class="form-group">
          <label>é€±ã®å¥‘ç´„æ™‚é–“ï¼ˆhï¼‰</label>
          <input type="number" id="weekly-hours" min="0" step="0.5" placeholder="ä¾‹ï¼š40">
        </div>
        <div class="form-group">
          <label>æœˆã®å¥‘ç´„æ™‚é–“ï¼ˆhï¼‰</label>
          <input type="number" id="monthly-hours" min="0" step="0.5" placeholder="ä¾‹ï¼š173">
        </div>
      </div>
      <!-- æ­£ç¤¾å“¡ç”¨: åŸºæœ¬çµ¦ãƒ»æ®‹æ¥­è¨­å®š -->
      <div id="seishain-fields" class="form-row" style="background:#EFF6FF;border-radius:6px;padding:10px;margin-bottom:8px;">
        <span style="width:100%;font-size:11px;font-weight:700;color:#1D4ED8;margin-bottom:4px;">æ­£ç¤¾å“¡è¨­å®š</span>
        <div class="form-group">
          <label>æœˆåŸºæœ¬çµ¦ï¼ˆå††ï¼‰</label>
          <input type="number" id="base-salary" min="0" placeholder="ä¾‹ï¼š220000" oninput="RosterModule.calcWageFromSalary()">
        </div>
        <div class="form-group">
          <label>æ³•å®šåŠ´åƒæ™‚é–“ï¼ˆh/æœˆï¼‰</label>
          <input type="number" id="legal-hours" min="1" value="173" placeholder="173" oninput="RosterModule.calcWageFromSalary()">
        </div>
        <div class="form-group">
          <label>å›ºå®šæ®‹æ¥­æ™‚é–“ï¼ˆh/æœˆï¼‰</label>
          <input type="number" id="overtime-hours" min="0" value="0" placeholder="ä¾‹ï¼š30" oninput="RosterModule.calcWageFromSalary()">
        </div>
        <div class="form-group">
          <label style="color:#059669;font-weight:700;">æ›ç®—æ™‚çµ¦ï¼ˆå††ï¼‰â€»è‡ªå‹•</label>
          <input type="number" id="hourly-wage" min="0" placeholder="è‡ªå‹•è¨ˆç®—" readonly style="background:#F0FDF4;font-weight:700;">
        </div>
      </div>
      <!-- ãƒ‘ãƒ¼ãƒˆãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆç”¨: æ™‚çµ¦ç›´æ¥å…¥åŠ› -->
      <div id="part-fields" class="form-row" style="display:none;">
        <div class="form-group">
          <label>æ™‚çµ¦ï¼ˆå††ï¼‰</label>
          <input type="number" id="hourly-wage-part" min="0" placeholder="ä¾‹ï¼š1050">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group" style="justify-content:flex-end;flex-direction:row;gap:8px;">
          <button type="submit" class="btn-primary">ç™»éŒ² / æ›´æ–°</button>
          <button type="button" id="roster-clear-btn" class="btn-secondary">ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <h3>ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</h3>
    <table>
      <thead>
        <tr>
          <th>ã‚¹ã‚¿ãƒƒãƒ•å</th>
          <th>é›‡ç”¨å½¢æ…‹</th>
          <th>é€±ã®å¥‘ç´„æ™‚é–“</th>
          <th>æœˆã®å¥‘ç´„æ™‚é–“</th>
          <th id="wage-col-header">çµ¦ä¸æƒ…å ±</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="roster-tbody">
        <tr><td colspan="6" style="text-align:center;color:var(--color-muted);">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ===== Tab 2: ã‚·ãƒ•ãƒˆå¸Œæœ›ãƒ•ã‚©ãƒ¼ãƒ  å‰åŠ ===== -->
<div id="panel-form-first" class="tab-panel">
  <div class="section-header">
    <h2>ã‚·ãƒ•ãƒˆå¸Œæœ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå‰åŠ 1ã€œ15æ—¥ï¼‰</h2>
    <p>ã‚¹ã‚¿ãƒƒãƒ•ãŒè‡ªåˆ†ã®å¸Œæœ›ã‚·ãƒ•ãƒˆã‚’å…¥åŠ›ã—ã¾ã™ã€‚</p>
  </div>
  <div class="card">
    <div class="form-meta">
      <div class="form-group">
        <label>å¯¾è±¡æœˆ</label>
        <input type="month" id="target-month-first">
      </div>
      <div class="form-group">
        <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
        <select id="staff-select-first"><option value="">--- ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ ---</option></select>
      </div>
    </div>
    <div style="overflow-x:auto;">
      <table class="shift-form-table" id="form-table-first">
        <thead>
          <tr>
            <th style="width:50px">æ—¥</th>
            <th style="width:36px">æ›œæ—¥</th>
            <th>å‡ºå‹¤æ™‚é–“</th>
            <th>é€€å‹¤æ™‚é–“</th>
          </tr>
        </thead>
        <tbody id="form-tbody-first"></tbody>
      </table>
    </div>
    <div style="margin-top:14px;display:flex;gap:10px;">
      <button id="form-submit-first" class="btn-primary">é€ä¿¡ã™ã‚‹</button>
      <button id="form-clear-first" class="btn-secondary">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</div>

<!-- ===== Tab 3: ã‚·ãƒ•ãƒˆå¸Œæœ›ãƒ•ã‚©ãƒ¼ãƒ  å¾ŒåŠ ===== -->
<div id="panel-form-second" class="tab-panel">
  <div class="section-header">
    <h2>ã‚·ãƒ•ãƒˆå¸Œæœ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå¾ŒåŠ 16ã€œæœ«æ—¥ï¼‰</h2>
    <p>ã‚¹ã‚¿ãƒƒãƒ•ãŒè‡ªåˆ†ã®å¸Œæœ›ã‚·ãƒ•ãƒˆã‚’å…¥åŠ›ã—ã¾ã™ã€‚</p>
  </div>
  <div class="card">
    <div class="form-meta">
      <div class="form-group">
        <label>å¯¾è±¡æœˆ</label>
        <input type="month" id="target-month-second">
      </div>
      <div class="form-group">
        <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
        <select id="staff-select-second"><option value="">--- ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ ---</option></select>
      </div>
    </div>
    <div style="overflow-x:auto;">
      <table class="shift-form-table" id="form-table-second">
        <thead>
          <tr>
            <th style="width:50px">æ—¥</th>
            <th style="width:36px">æ›œæ—¥</th>
            <th>å‡ºå‹¤æ™‚é–“</th>
            <th>é€€å‹¤æ™‚é–“</th>
          </tr>
        </thead>
        <tbody id="form-tbody-second"></tbody>
      </table>
    </div>
    <div style="margin-top:14px;display:flex;gap:10px;">
      <button id="form-submit-second" class="btn-primary">é€ä¿¡ã™ã‚‹</button>
      <button id="form-clear-second" class="btn-secondary">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</div>

<!-- ===== Tab 4: ã‚·ãƒ•ãƒˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ===== -->
<div id="panel-dashboard" class="tab-panel">
  <div class="section-header">
    <h2>ã‚·ãƒ•ãƒˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <p>ç®¡ç†è€…ãŒã‚·ãƒ•ãƒˆå¸Œæœ›ã®ç¢ºèªãƒ»èª¿æ•´ãƒ»åˆ†æã‚’è¡Œã„ã¾ã™ã€‚</p>
  </div>

  <!-- GASé€£æºè¨­å®š -->
  <div class="card" id="gas-settings-card" style="margin-bottom:16px;border:2px solid #4A90D9;">
    <h3 style="color:#2563EB;">ğŸ”— GASé€£æºè¨­å®š</h3>
    <p style="font-size:12px;color:var(--color-muted);margin-bottom:12px;">
      GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚¹ã‚¿ãƒƒãƒ•ãŒLINEã®URLã‹ã‚‰é€ä¿¡ã—ãŸã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’ã“ã“ã«å–ã‚Šè¾¼ã‚ã¾ã™ã€‚
    </p>
    <div class="form-row" style="align-items:flex-end;">
      <div class="form-group" style="flex:1;min-width:260px;">
        <label>GAS ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL</label>
        <input type="url" id="gas-url" placeholder="https://script.google.com/macros/s/.../exec" style="width:100%;">
      </div>
      <button id="save-gas-url-btn" class="btn-primary">URLã‚’ä¿å­˜</button>
      <button id="sync-gas-btn" class="btn-success" style="background:#4A90D9;">â˜ï¸ GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
    </div>
    <div id="gas-status" style="margin-top:8px;font-size:12px;"></div>
  </div>

  <!-- å¯¾è±¡æœˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
  <div class="dashboard-meta card" style="margin-bottom:16px;">
    <div class="form-group">
      <label>å¯¾è±¡æœˆ</label>
      <input type="month" id="dashboard-month">
    </div>
    <button id="export-excel-btn" class="btn-excel" style="align-self:flex-end;">ğŸ“¥ Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  </div>

  <!-- ãƒ•ã‚©ãƒ¼ãƒ URLã‚³ãƒ”ãƒ¼ -->
  <div class="card" id="form-url-card" style="margin-bottom:16px;border:2px solid #10B981;">
    <h3 style="color:#065F46;">ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•ç”¨ãƒ•ã‚©ãƒ¼ãƒ URL</h3>
    <p style="font-size:12px;color:var(--color-muted);margin-bottom:8px;">
      å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ãã®ã¾ã¾LINEã«è²¼ã‚Šä»˜ã‘ã¦é€ã‚Œã¾ã™ã€‚
    </p>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <div style="display:flex;align-items:center;gap:8px;background:#F0FDF4;border:1px solid #BBF7D0;border-radius:6px;padding:8px 10px;">
        <span style="font-size:11px;color:#065F46;font-weight:600;white-space:nowrap;">å‰åŠ</span>
        <span id="url-preview-first" style="font-size:11px;color:#374151;word-break:break-all;flex:1;">â€”</span>
        <button id="copy-url-first-btn" class="btn-primary" style="background:#10B981;white-space:nowrap;padding:6px 12px;font-size:12px;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px;background:#F0FDF4;border:1px solid #BBF7D0;border-radius:6px;padding:8px 10px;">
        <span style="font-size:11px;color:#065F46;font-weight:600;white-space:nowrap;">å¾ŒåŠ</span>
        <span id="url-preview-second" style="font-size:11px;color:#374151;word-break:break-all;flex:1;">â€”</span>
        <button id="copy-url-second-btn" class="btn-primary" style="background:#10B981;white-space:nowrap;padding:6px 12px;font-size:12px;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  </div>

  <!-- â‘  è¨­å®šã‚¨ãƒªã‚¢ -->
  <div class="card" id="settings-area">
    <h3>â‘  è¨­å®š</h3>
    <div class="settings-grid">
      <div class="form-group">
        <label>æœˆã®äººä»¶è²»äºˆç®—ï¼ˆå††ï¼‰</label>
        <input type="number" id="s-budget" min="0" placeholder="ä¾‹ï¼š500000">
      </div>
      <div class="form-group">
        <label>å–¶æ¥­é–‹å§‹æ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</label>
        <input type="time" id="s-open-time" value="09:00">
      </div>
      <div class="form-group">
        <label>å–¶æ¥­çµ‚äº†æ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</label>
        <input type="time" id="s-close-time" value="22:00">
      </div>
      <div class="form-group">
        <label>å¹³æ—¥ã®å¿…è¦äººæ•°</label>
        <input type="number" id="s-required-staff" min="0" placeholder="ä¾‹ï¼š2">
      </div>
      <div class="form-group">
        <label>åœŸæ—¥ãƒ»ç¥ã®å¿…è¦äººæ•°</label>
        <input type="number" id="s-required-staff-we" min="0" placeholder="ä¾‹ï¼š4">
      </div>
    </div>

    <!-- æ›œæ—¥åˆ¥å–¶æ¥­æ™‚é–“ï¼ˆä¾‹å¤–è¨­å®šï¼‰ -->
    <div style="margin-top:14px;border-top:1px solid #E5E7EB;padding-top:12px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
        <span style="font-weight:600;font-size:13px;">æ›œæ—¥åˆ¥ã®å–¶æ¥­æ™‚é–“ï¼ˆä¾‹å¤–ï¼‰</span>
        <select id="s-add-day-group" style="font-size:12px;padding:3px 6px;border:1px solid #D1D5DB;border-radius:4px;">
          <option value="">è¿½åŠ ã™ã‚‹æ›œæ—¥ã‚’é¸æŠâ€¦</option>
          <optgroup label="â”€â”€ å–¶æ¥­æ™‚é–“ãŒé•ã†æ›œæ—¥ â”€â”€">
            <option value="mon">æœˆæ›œ</option>
            <option value="tue">ç«æ›œ</option>
            <option value="wed">æ°´æ›œ</option>
            <option value="thu">æœ¨æ›œ</option>
            <option value="fri">é‡‘æ›œ</option>
            <option value="sat">åœŸæ›œ</option>
            <option value="sun">æ—¥ãƒ»ç¥</option>
          </optgroup>
          <optgroup label="â”€â”€ å®šä¼‘æ—¥ â”€â”€">
            <option value="closed_mon">æœˆæ›œï¼ˆå®šä¼‘ï¼‰</option>
            <option value="closed_tue">ç«æ›œï¼ˆå®šä¼‘ï¼‰</option>
            <option value="closed_wed">æ°´æ›œï¼ˆå®šä¼‘ï¼‰</option>
            <option value="closed_thu">æœ¨æ›œï¼ˆå®šä¼‘ï¼‰</option>
            <option value="closed_fri">é‡‘æ›œï¼ˆå®šä¼‘ï¼‰</option>
            <option value="closed_sat">åœŸæ›œï¼ˆå®šä¼‘ï¼‰</option>
            <option value="closed_sun">æ—¥ãƒ»ç¥ï¼ˆå®šä¼‘ï¼‰</option>
          </optgroup>
        </select>
        <button id="s-add-day-hours-btn" class="btn-primary" style="padding:3px 10px;font-size:12px;">ï¼‹ è¿½åŠ </button>
      </div>
      <div style="font-size:11px;color:var(--color-muted);margin-bottom:8px;">è¨­å®šã—ãŸæ›œæ—¥ã‚°ãƒ«ãƒ¼ãƒ—ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚é–“ã‚ˆã‚Šå„ªå…ˆã•ã‚Œã¾ã™</div>
      <div id="day-hours-list"><!-- JS ã§è¡Œã‚’ç”Ÿæˆ --></div>
    </div>

    <div id="avg-wage-info" style="margin:12px 0 8px;font-size:12px;color:var(--color-muted);"></div>
    <button id="save-settings-btn" class="btn-primary">è¨­å®šã‚’ä¿å­˜</button>
  </div>

  <!-- â‘¡ ã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="card" id="calendar-area">
    <h3>â‘¡ ã‚·ãƒ•ãƒˆèª¿æ•´ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px;font-size:12px;">
      <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:14px;height:14px;background:#E5E7EB;border-radius:3px;"></span>å¸Œæœ›ã‚ã‚Šï¼ˆæœªç¢ºå®šï¼‰</span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:14px;height:14px;background:#D1FAE5;border-radius:3px;border:1px solid #6EE7B7;"></span>ç¢ºå®šæ¸ˆã¿</span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:14px;height:14px;background:#FEF08A;border-radius:3px;"></span>ç·¨é›†ä¸­</span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:14px;height:14px;background:var(--color-saturday-bg);border-radius:3px;"></span>åœŸæ›œ</span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:14px;height:14px;background:var(--color-sunday-bg);border-radius:3px;"></span>æ—¥ç¥</span>
      <span style="margin-left:8px;">äººæ•°ï¼šğŸ”´è¶…é ğŸ”µä¸è¶³ ğŸŸ¢é©æ­£</span>
    </div>
    <div class="calendar-scroll">
      <table id="shift-calendar">
        <tbody><tr><td style="color:var(--color-muted);text-align:center;padding:20px;">å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- â‘¢ åˆ†æã‚¨ãƒªã‚¢ -->
  <div class="card" id="analysis-area">
    <h3>â‘¢ åˆ†æï¼ˆäºˆç®—ãƒ»ç›®æ¨™å£²ä¸Šï¼‰</h3>
    <div id="analysis-content">
      <p style="color:var(--color-muted);">è¨­å®šã‚’ä¿å­˜ã™ã‚‹ã¨è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</p>
    </div>
  </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
<div id="toast"></div>

<script>
'use strict';

// ============================================================
// EventBus
// ============================================================
const EventBus = {
  _listeners: {},
  on(event, fn) { (this._listeners[event] ??= []).push(fn); },
  emit(event, data) { (this._listeners[event] ?? []).forEach(fn => fn(data)); }
};

// ============================================================
// Utils
// ============================================================
const Utils = {
  // æ—¥æœ¬ã®ç¥æ—¥ï¼ˆ2024ã€œ2026å¹´ä¸»è¦ç¥æ—¥ï¼‰
  _holidays: new Set([
    '2024-01-01','2024-01-08','2024-02-11','2024-02-12','2024-02-23',
    '2024-03-20','2024-04-29','2024-05-03','2024-05-04','2024-05-05','2024-05-06',
    '2024-07-15','2024-08-11','2024-08-12','2024-09-16','2024-09-22','2024-09-23',
    '2024-10-14','2024-11-03','2024-11-04','2024-11-23','2024-12-23',
    '2025-01-01','2025-01-13','2025-02-11','2025-02-23','2025-02-24',
    '2025-03-20','2025-04-29','2025-05-03','2025-05-04','2025-05-05','2025-05-06',
    '2025-07-21','2025-08-11','2025-09-15','2025-09-21','2025-09-22','2025-09-23',
    '2025-10-13','2025-11-03','2025-11-23','2025-11-24',
    '2026-01-01','2026-01-12','2026-02-11','2026-02-23',
    '2026-03-20','2026-04-29','2026-05-03','2026-05-04','2026-05-05','2026-05-06',
    '2026-07-20','2026-08-11','2026-09-21','2026-09-22','2026-09-23',
    '2026-10-12','2026-11-03','2026-11-23'
  ]),
  _dayNames: ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'],

  isHoliday(dateStr) { return this._holidays.has(dateStr); },

  getDaysInMonth(yearMonth) {
    const [y, m] = yearMonth.split('-').map(Number);
    const lastDay = new Date(y, m, 0).getDate();
    const result = [];
    for (let d = 1; d <= lastDay; d++) {
      const pad = String(d).padStart(2,'0');
      const dateStr = `${yearMonth}-${pad}`;
      const date = new Date(dateStr + 'T00:00:00');
      const dow = date.getDay(); // 0=æ—¥
      result.push({
        day: d,
        dateStr,
        dow,
        dayName: this._dayNames[dow],
        isSunday: dow === 0,
        isSaturday: dow === 6,
        isHoliday: this.isHoliday(dateStr)
      });
    }
    return result;
  },

  timeToHours(timeStr) {
    if (!timeStr || timeStr === 'any' || timeStr === '') return null;
    const [h, min] = timeStr.split(':').map(Number);
    return h + min / 60;
  },

  calcWorkHours(start, end) {
    const s = this.timeToHours(start);
    const e = this.timeToHours(end);
    if (s === null || e === null) return null;
    return Math.max(0, e - s);
  },

  formatYen(n) {
    if (n === null || n === undefined || isNaN(n)) return 'â€”';
    return 'Â¥' + Math.round(n).toLocaleString('ja-JP');
  },

  uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); },

  getISOWeekKey(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const tmp = new Date(d);
    tmp.setHours(0,0,0,0);
    tmp.setDate(tmp.getDate() + 3 - (tmp.getDay() + 6) % 7);
    const w1 = new Date(tmp.getFullYear(), 0, 4);
    const weekNum = 1 + Math.round(((tmp - w1) / 86400000 - 3 + (w1.getDay() + 6) % 7) / 7);
    return `${tmp.getFullYear()}-W${String(weekNum).padStart(2,'0')}`;
  },

  showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  },

  // å‡ºå‹¤æ™‚é–“ã®é¸æŠè‚¢HTML
  buildStartOptions(selected) {
    const times = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00'];
    let html = `<option value="">â€”</option><option value="any"${selected==='any'?' selected':''}>ã„ã¤ã‹ã‚‰ã§ã‚‚</option>`;
    times.forEach(t => { html += `<option value="${t}"${selected===t?' selected':''}>${t.replace(':00','æ™‚')}</option>`; });
    return html;
  },

  buildEndOptions(selected) {
    const times = ['12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00'];
    let html = `<option value="">â€”</option><option value="any"${selected==='any'?' selected':''}>ã„ã¤ã¾ã§ã§ã‚‚</option>`;
    times.forEach(t => { html += `<option value="${t}"${selected===t?' selected':''}>${t.replace(':00','æ™‚')}</option>`; });
    return html;
  }
};

// ============================================================
// AppState
// ============================================================
const AppState = {
  roster: [],
  requests: {},    // { "YYYY-MM": { staffName: { "1": {start,end}, ... } } }
  confirmed: {},   // { "YYYY-MM": { "1": [{staffName,start,end},...], ... } }
  settings: {},    // { "YYYY-MM": {budget,wage,requiredStaff,weekdayProd,weekendProd} }
  currentDashMonth: null,

  loadRoster() {
    this.roster = JSON.parse(localStorage.getItem('staff_roster') ?? '[]');
  },
  saveRoster() {
    localStorage.setItem('staff_roster', JSON.stringify(this.roster));
  },
  loadMonth(month) {
    this.requests[month] = JSON.parse(localStorage.getItem(`shift_requests_${month}`) ?? '{}');
    this.confirmed[month] = JSON.parse(localStorage.getItem(`confirmed_shifts_${month}`) ?? '{}');
    this.settings[month]  = JSON.parse(localStorage.getItem(`settings_${month}`) ?? '{}');
  },
  saveRequests(month) {
    localStorage.setItem(`shift_requests_${month}`, JSON.stringify(this.requests[month] ?? {}));
  },
  saveConfirmed(month) {
    localStorage.setItem(`confirmed_shifts_${month}`, JSON.stringify(this.confirmed[month] ?? {}));
  },
  saveSettings(month) {
    localStorage.setItem(`settings_${month}`, JSON.stringify(this.settings[month] ?? {}));
  }
};
AppState.loadRoster();

// ============================================================
// RosterModule
// ============================================================
const RosterModule = {
  _wageVisible: false,
  _adminPassword: 'admin1234',

  // çµ¦ä¸è¡¨ç¤ºåˆ‡æ›¿
  toggleWageVisibility() {
    const input = document.getElementById('admin-password-input');
    const changePwArea = document.getElementById('change-password-area');
    if (!this._wageVisible) {
      if (input.value !== this._adminPassword) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
        return;
      }
      this._wageVisible = true;
      document.getElementById('wage-lock-status').textContent = 'è¡¨ç¤ºä¸­';
      document.getElementById('wage-lock-status').style.color = '#059669';
      document.getElementById('wage-toggle-btn').textContent = 'éè¡¨ç¤ºã«ã™ã‚‹';
      input.value = '';
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
      changePwArea.style.display = 'flex';
    } else {
      this._wageVisible = false;
      document.getElementById('wage-lock-status').textContent = 'éè¡¨ç¤ºï¼ˆâ—â—â—â—ï¼‰';
      document.getElementById('wage-lock-status').style.color = '';
      document.getElementById('wage-toggle-btn').textContent = 'è¡¨ç¤ºã™ã‚‹';
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
      changePwArea.style.display = 'none';
      document.getElementById('new-password-input').value = '';
      document.getElementById('new-password-confirm').value = '';
    }
    this.render();
  },

  // é›‡ç”¨å½¢æ…‹å¤‰æ›´æ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ åˆ‡æ›¿
  onEmploymentTypeChange() {
    const type = document.getElementById('employment-type').value;
    const isSeishain = (type === 'æ­£ç¤¾å“¡');
    document.getElementById('seishain-fields').style.display = isSeishain ? '' : 'none';
    document.getElementById('part-fields').style.display = isSeishain ? 'none' : '';
    if (isSeishain) this.calcWageFromSalary();
  },

  // æ­£ç¤¾å“¡ï¼šåŸºæœ¬çµ¦â†’æ™‚çµ¦æ›ç®—
  calcWageFromSalary() {
    const salary   = parseFloat(document.getElementById('base-salary').value) || 0;
    const legal    = parseFloat(document.getElementById('legal-hours').value) || 173;
    const overtime = parseFloat(document.getElementById('overtime-hours').value) || 0;
    if (salary > 0) {
      // æ™‚çµ¦ = åŸºæœ¬çµ¦ Ã· ï¼ˆæ³•å®šåŠ´åƒæ™‚é–“ + æ®‹æ¥­æ™‚é–“ï¼‰
      const wage = Math.round(salary / (legal + overtime));
      document.getElementById('hourly-wage').value = wage;
    } else {
      document.getElementById('hourly-wage').value = '';
    }
  },

  render() {
    const tbody = document.getElementById('roster-tbody');
    if (AppState.roster.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--color-muted);">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
      return;
    }
    const showWage = this._wageVisible;
    tbody.innerHTML = AppState.roster.map(s => {
      // çµ¦ä¸è¡¨ç¤º
      let wageCell = '';
      if (s.employmentType === 'æ­£ç¤¾å“¡') {
        const salaryStr = showWage
          ? `åŸºæœ¬çµ¦ Â¥${(s.baseSalary ?? 0).toLocaleString()} / æ™‚çµ¦æ›ç®— Â¥${(s.wage ?? 0).toLocaleString()}<br><small>æ³•å®š${s.legalHours ?? 173}h + å›ºå®šæ®‹æ¥­${s.overtimeHours ?? 0}h</small>`
          : 'â—â—â—â—';
        wageCell = salaryStr;
      } else {
        wageCell = showWage ? `Â¥${(s.wage ?? 0).toLocaleString()}/h` : 'â—â—â—â—';
      }
      return `
      <tr>
        <td><strong>${s.name}</strong></td>
        <td>${s.employmentType}</td>
        <td>${s.weeklyHours ?? 'â€”'} h</td>
        <td>${s.monthlyHours ?? 'â€”'} h</td>
        <td>${wageCell}</td>
        <td>
          <div class="roster-actions">
            <button class="btn-secondary" onclick="RosterModule.edit('${s.id}')">ç·¨é›†</button>
            <button class="btn-danger" onclick="RosterModule.delete('${s.id}')">å‰Šé™¤</button>
          </div>
        </td>
      </tr>`;
    }).join('');
  },

  save(e) {
    e.preventDefault();
    const name = document.getElementById('staff-name').value.trim();
    if (!name) { alert('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const editId = document.getElementById('edit-staff-id').value;
    const empType = document.getElementById('employment-type').value;
    const isSeishain = (empType === 'æ­£ç¤¾å“¡');

    let wage = null;
    let baseSalary = null, legalHours = null, overtimeHours = null;
    if (isSeishain) {
      baseSalary    = parseFloat(document.getElementById('base-salary').value) || null;
      legalHours    = parseFloat(document.getElementById('legal-hours').value) || 173;
      overtimeHours = parseFloat(document.getElementById('overtime-hours').value) || 0;
      wage          = parseFloat(document.getElementById('hourly-wage').value) || null;
    } else {
      wage = parseFloat(document.getElementById('hourly-wage-part').value) || null;
    }

    const staff = {
      id: editId || Utils.uid(),
      name,
      employmentType: empType,
      weeklyHours:    parseFloat(document.getElementById('weekly-hours').value) || null,
      monthlyHours:   parseFloat(document.getElementById('monthly-hours').value) || null,
      baseSalary, legalHours, overtimeHours, wage
    };
    if (editId) {
      const idx = AppState.roster.findIndex(s => s.id === editId);
      if (idx >= 0) AppState.roster[idx] = staff;
    } else {
      AppState.roster.push(staff);
    }
    AppState.saveRoster();
    this.clearForm();
    EventBus.emit('rosterChanged');
    Utils.showToast('ä¿å­˜ã—ã¾ã—ãŸ');
  },

  edit(id) {
    const s = AppState.roster.find(s => s.id === id);
    if (!s) return;
    const isSeishain = (s.employmentType === 'æ­£ç¤¾å“¡');
    document.getElementById('edit-staff-id').value = s.id;
    document.getElementById('staff-name').value = s.name;
    document.getElementById('employment-type').value = s.employmentType;
    document.getElementById('weekly-hours').value = s.weeklyHours ?? '';
    document.getElementById('monthly-hours').value = s.monthlyHours ?? '';
    this.onEmploymentTypeChange();
    if (isSeishain) {
      document.getElementById('base-salary').value = s.baseSalary ?? '';
      document.getElementById('legal-hours').value = s.legalHours ?? 173;
      document.getElementById('overtime-hours').value = s.overtimeHours ?? 0;
      document.getElementById('hourly-wage').value = s.wage ?? '';
    } else {
      document.getElementById('hourly-wage-part').value = s.wage ?? '';
    }
    document.getElementById('staff-name').focus();
  },

  delete(id) {
    const s = AppState.roster.find(s => s.id === id);
    if (!s) return;
    if (!confirm(`ã€Œ${s.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    AppState.roster = AppState.roster.filter(s => s.id !== id);
    AppState.saveRoster();
    EventBus.emit('rosterChanged');
    Utils.showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
  },

  clearForm() {
    document.getElementById('edit-staff-id').value = '';
    document.getElementById('roster-form').reset();
    document.getElementById('legal-hours').value = 173;
    document.getElementById('overtime-hours').value = 0;
    this.onEmploymentTypeChange();
  },

  populateDropdowns() {
    const names = AppState.roster.map(s => s.name);
    ['first','second'].forEach(half => {
      const sel = document.getElementById(`staff-select-${half}`);
      const cur = sel.value;
      sel.innerHTML = '<option value="">--- ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ ---</option>' +
        names.map(n => `<option value="${n}"${n===cur?' selected':''}>${n}</option>`).join('');
    });
  }
};

// ============================================================
// FormModule
// ============================================================
const FormModule = {
  buildTable(half, month) {
    const isFirst = (half === 'first');
    const days = month ? Utils.getDaysInMonth(month).filter(d => isFirst ? d.day <= 15 : d.day >= 16) : [];
    const tbody = document.getElementById(`form-tbody-${half}`);
    if (!month || days.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--color-muted);">å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>';
      return;
    }
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å–å¾—
    const staffName = document.getElementById(`staff-select-${half}`).value;
    const existing = (staffName && AppState.requests[month]?.[staffName]) ?? {};

    tbody.innerHTML = days.map(d => {
      const cls = (d.isHoliday || d.isSunday) ? 'day-holiday' : d.isSaturday ? 'day-saturday' : '';
      const ex = existing[d.day] ?? {};
      return `<tr class="${cls}">
        <td class="cell-date">${d.day}æ—¥</td>
        <td class="cell-day">${d.dayName}</td>
        <td><select data-day="${d.day}" data-type="start">${Utils.buildStartOptions(ex.start)}</select></td>
        <td><select data-day="${d.day}" data-type="end">${Utils.buildEndOptions(ex.end)}</select></td>
      </tr>`;
    }).join('');
  },

  submit(half) {
    const month = document.getElementById(`target-month-${half}`).value;
    const staffName = document.getElementById(`staff-select-${half}`).value;
    if (!month) { alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!staffName) { alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

    if (!AppState.requests[month]) AppState.requests[month] = {};
    if (!AppState.requests[month][staffName]) AppState.requests[month][staffName] = {};

    const tbody = document.getElementById(`form-tbody-${half}`);
    const rows = tbody.querySelectorAll('tr[class]');  // classä»˜ãè¡Œ
    const allRows = tbody.querySelectorAll('tr');

    // å…¨è¡Œã‚’èµ°æŸ»
    const selects = tbody.querySelectorAll('select[data-day]');
    const startMap = {}, endMap = {};
    selects.forEach(sel => {
      const day = sel.dataset.day;
      if (sel.dataset.type === 'start') startMap[day] = sel.value;
      else endMap[day] = sel.value;
    });

    const isFirst = (half === 'first');
    const days = Utils.getDaysInMonth(month).filter(d => isFirst ? d.day <= 15 : d.day >= 16);

    days.forEach(d => {
      const s = startMap[d.day] ?? '';
      const e = endMap[d.day] ?? '';
      if (s || e) {
        AppState.requests[month][staffName][d.day] = { start: s, end: e };
      } else {
        delete AppState.requests[month][staffName][d.day];
      }
    });

    AppState.saveRequests(month);
    EventBus.emit('requestSaved', { month });
    Utils.showToast('ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
  },

  clearForm(half) {
    const tbody = document.getElementById(`form-tbody-${half}`);
    tbody.querySelectorAll('select').forEach(sel => { sel.value = ''; });
  }
};

// ============================================================
// DashboardModule
// ============================================================
const DashboardModule = {
  render(month) {
    if (!month) return;
    if (!AppState.requests[month]) AppState.loadMonth(month);
    if (!AppState.confirmed[month]) AppState.confirmed[month] = {};
    if (!AppState.settings[month]) AppState.settings[month] = {};
    this.loadSettings(month);
    this.buildCalendar(month);
    this.buildAnalysis(month);
    AlertModule.checkOverages(month);
  },

  loadSettings(month) {
    const s = AppState.settings[month] ?? {};
    document.getElementById('s-budget').value         = s.budget    ?? '';
    document.getElementById('s-open-time').value      = s.openTime  ?? '09:00';
    document.getElementById('s-close-time').value     = s.closeTime ?? '22:00';
    document.getElementById('s-required-staff').value    = s.requiredStaff   ?? '';
    document.getElementById('s-required-staff-we').value = s.requiredStaffWe ?? '';

    // æ›œæ—¥åˆ¥å–¶æ¥­æ™‚é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ
    // ä¿å­˜æ¸ˆã¿ã®ä¾‹å¤–è¨­å®šã‚’è¡Œã¨ã—ã¦å¾©å…ƒ
    this.renderDayHoursList(s.dayHours ?? {});
    this.showAvgWage();
  },

  // æ›œæ—¥åˆ¥å–¶æ¥­æ™‚é–“ã®ä¾‹å¤–ãƒªã‚¹ãƒˆã‚’æç”»
  renderDayHoursList(dayHours) {
    const list = document.getElementById('day-hours-list');
    list.innerHTML = '';
    Object.entries(dayHours).forEach(([key, val]) => {
      this._appendDayHoursRow(key, val.open, val.close);
    });
    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰è¿½åŠ æ¸ˆã¿ã®æ›œæ—¥ã‚’é™¤å¤–
    this._updateAddSelect();
  },

  // 1è¡Œè¿½åŠ 
  _appendDayHoursRow(key, open, close) {
    const LABELS = {
      mon:'æœˆæ›œ', tue:'ç«æ›œ', wed:'æ°´æ›œ', thu:'æœ¨æ›œ', fri:'é‡‘æ›œ', sat:'åœŸæ›œ', sun:'æ—¥ãƒ»ç¥',
      closed_mon:'æœˆæ›œï¼ˆå®šä¼‘æ—¥ï¼‰', closed_tue:'ç«æ›œï¼ˆå®šä¼‘æ—¥ï¼‰', closed_wed:'æ°´æ›œï¼ˆå®šä¼‘æ—¥ï¼‰',
      closed_thu:'æœ¨æ›œï¼ˆå®šä¼‘æ—¥ï¼‰', closed_fri:'é‡‘æ›œï¼ˆå®šä¼‘æ—¥ï¼‰', closed_sat:'åœŸæ›œï¼ˆå®šä¼‘æ—¥ï¼‰', closed_sun:'æ—¥ãƒ»ç¥ï¼ˆå®šä¼‘æ—¥ï¼‰'
    };
    const CLASSES = {
      mon:'row-weekday', tue:'row-weekday', wed:'row-weekday', thu:'row-weekday', fri:'row-weekday',
      sat:'row-saturday', sun:'row-sunday',
      closed_mon:'row-closed', closed_tue:'row-closed', closed_wed:'row-closed',
      closed_thu:'row-closed', closed_fri:'row-closed', closed_sat:'row-closed', closed_sun:'row-closed'
    };
    const isClosed = key.startsWith('closed_');
    const list = document.getElementById('day-hours-list');
    const row = document.createElement('div');
    row.className = `day-hours-row ${CLASSES[key] ?? ''}`;
    row.dataset.key = key;
    if (isClosed) {
      row.innerHTML = `
        <span class="row-label">${LABELS[key] ?? key}</span>
        <span style="font-size:12px;color:#6B7280;font-style:italic;">çµ‚æ—¥ä¼‘æ¥­ï¼ˆã‚·ãƒ•ãƒˆå…¥åŠ›ä¸å¯ï¼‰</span>
        <button class="btn-remove-row" title="å‰Šé™¤">Ã—</button>`;
    } else {
      row.innerHTML = `
        <span class="row-label">${LABELS[key] ?? key}</span>
        <span style="font-size:12px;color:var(--color-muted);">é–‹å§‹</span>
        <input type="time" class="dh-open"  value="${open  ?? ''}" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ">
        <span style="font-size:12px;color:var(--color-muted);">çµ‚äº†</span>
        <input type="time" class="dh-close" value="${close ?? ''}" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ">
        <button class="btn-remove-row" title="å‰Šé™¤">Ã—</button>`;
    }
    row.querySelector('.btn-remove-row').addEventListener('click', () => {
      row.remove();
      this._updateAddSelect();
    });
    list.appendChild(row);
  },

  // è¿½åŠ æ¸ˆã¿æ›œæ—¥ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰é™¤å¤–
  _updateAddSelect() {
    const sel = document.getElementById('s-add-day-group');
    const used = new Set([...document.querySelectorAll('#day-hours-list .day-hours-row')].map(r => r.dataset.key));
    [...sel.options].forEach(opt => {
      if (opt.value) opt.disabled = used.has(opt.value);
    });
  },

  // ã‚¹ã‚¿ãƒƒãƒ•åç°¿ã‹ã‚‰å¹³å‡æ™‚çµ¦ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
  showAvgWage() {
    const info = document.getElementById('avg-wage-info');
    if (!info) return;
    const wages = AppState.roster
      .map(s => s.wage)
      .filter(w => w && w > 0);
    if (wages.length === 0) {
      info.textContent = 'â€» ã‚¹ã‚¿ãƒƒãƒ•åç°¿ã«æ™‚çµ¦ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ç·åŠ´åƒå¯èƒ½æ™‚é–“ãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™';
      return;
    }
    const avg = Math.round(wages.reduce((a, b) => a + b, 0) / wages.length);
    info.innerHTML = `ğŸ“Š åç°¿ã®å¹³å‡æ™‚çµ¦ï¼š<strong>${avg.toLocaleString()}å††</strong>ï¼ˆ${wages.length}åã®å¹³å‡ï¼‰ã€€â†’ ç·åŠ´åƒå¯èƒ½æ™‚é–“ã®è¨ˆç®—ã«ä½¿ç”¨`;
  },

  saveSettings(month) {
    // æ›œæ—¥åˆ¥ä¾‹å¤–è¨­å®šã‚’åé›†ï¼ˆå®šä¼‘æ—¥ã¯open/closeãªã—ï¼‰
    const dayHours = {};
    document.querySelectorAll('#day-hours-list .day-hours-row').forEach(row => {
      const key = row.dataset.key;
      if (!key) return;
      if (key.startsWith('closed_')) {
        dayHours[key] = { closed: true };  // å®šä¼‘æ—¥ãƒ•ãƒ©ã‚°
      } else {
        const open  = row.querySelector('.dh-open')?.value  ?? '';
        const close = row.querySelector('.dh-close')?.value ?? '';
        dayHours[key] = { open, close };
      }
    });

    AppState.settings[month] = {
      budget:          parseFloat(document.getElementById('s-budget').value) || 0,
      openTime:        document.getElementById('s-open-time').value  || '09:00',
      closeTime:       document.getElementById('s-close-time').value || '22:00',
      requiredStaff:   parseInt(document.getElementById('s-required-staff').value)   || 0,
      requiredStaffWe: parseInt(document.getElementById('s-required-staff-we').value) || 0,
      dayHours,
    };
    AppState.saveSettings(month);
    this.buildAnalysis(month);
    AlertModule.checkOverages(month);
    Utils.showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  },

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆå¸Œæœ›æå‡ºæ¸ˆã¿ï¼‰
  _getStaffList(month) {
    const req = AppState.requests[month] ?? {};
    return Object.keys(req).filter(name => {
      const days = req[name];
      return Object.keys(days).length > 0;
    });
  },

  buildCalendar(month) {
    const staffList = this._getStaffList(month);
    const days = Utils.getDaysInMonth(month);
    const settings = AppState.settings[month] ?? {};
    const confirmed = AppState.confirmed[month] ?? {};
    const requests  = AppState.requests[month]  ?? {};
    const table = document.getElementById('shift-calendar');

    if (staffList.length === 0) {
      table.innerHTML = '<tbody><tr><td style="text-align:center;color:var(--color-muted);padding:20px;">ã‚·ãƒ•ãƒˆå¸Œæœ›ã®æå‡ºãŒã‚ã‚Šã¾ã›ã‚“<br><small>GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã‹ã€ã‚·ãƒ•ãƒˆå¸Œæœ›ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„</small></td></tr></tbody>';
      return;
    }

    // ===== ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ1: ã‚¹ã‚¿ãƒƒãƒ•ååˆ— + æ—¥ä»˜ =====
    const colClass = d => (d.isHoliday || d.isSunday) ? 'col-hol' : d.isSaturday ? 'col-sat' : '';

    let html = '<thead>';

    // è¡Œ1: æ—¥ä»˜ç•ªå·
    html += `<tr>
      <th class="cal-staff-name" style="position:sticky;left:0;z-index:20;background:#F8FAFC;">ã‚¹ã‚¿ãƒƒãƒ•</th>`;
    days.forEach(d => {
      const cc = colClass(d);
      html += `<th class="cal-head-date ${cc}">${d.day}</th>`;
    });
    html += '</tr>';

    // è¡Œ2: æ›œæ—¥
    html += '<tr>';
    html += `<th style="position:sticky;left:0;z-index:20;background:#F8FAFC;font-size:10px;color:var(--color-muted);">ï¼ˆæ›œæ—¥ï¼‰</th>`;
    days.forEach(d => {
      const cc = colClass(d);
      html += `<th class="cal-head-dow ${cc}" style="color:${(d.isSunday||d.isHoliday)?'#be185d':d.isSaturday?'#1d4ed8':'inherit'}">${d.dayName}</th>`;
    });
    html += '</tr>';

    html += '</thead><tbody>';

    // ===== ã‚¹ã‚¿ãƒƒãƒ•è¡Œ =====
    staffList.forEach(name => {
      html += `<tr>
        <td class="cal-staff-name" data-staff="${name}">${name}</td>`;

      days.forEach(d => {
        const cc = colClass(d);
        const req       = requests[name]?.[d.day];
        const confDay   = confirmed[d.day] ?? [];
        const confEntry = confDay.find(e => e.staffName === name);
        const isDayOff  = !!confEntry?.dayOff;
        const isConf    = !isDayOff && !!(confEntry?.start || confEntry?.end);
        const hasReq    = !!req;

        // ã‚»ãƒ«ã®çŠ¶æ…‹ã‚¯ãƒ©ã‚¹
        const cellCls = isConf ? 'shift-cell confirmed' : hasReq ? 'shift-cell has-request' : 'shift-cell';

        // å¸Œæœ›æ™‚é–“ãƒ©ãƒ™ãƒ«ï¼ˆã€Œã„ã¤ã‹ã‚‰ã§ã‚‚ã€â†’ é–‹åº—æ™‚é–“ã€ã€Œã„ã¤ã¾ã§ã§ã‚‚ã€â†’ é–‰åº—æ™‚é–“ï¼‰
        const OPEN_TIME  = settings.openTime  || '09:00';
        const CLOSE_TIME = settings.closeTime || '22:00';
        function resolveTime(val, fallback) {
          if (!val) return '';
          if (val === 'any') return fallback;
          return val;
        }
        let reqLabel = '';
        if (hasReq) {
          const rs = resolveTime(req.start, OPEN_TIME);
          const re = resolveTime(req.end,   CLOSE_TIME);
          reqLabel = `<span class="shift-request-label">å¸Œæœ›: ${rs}ã€œ${re}</span>`;
        }

        // ç¢ºå®šæ™‚é–“ã®åˆæœŸå€¤ï¼ˆç¢ºå®šæ¸ˆã¿ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°å¸Œæœ›ã‚’ãƒ—ãƒªãƒ•ã‚£ãƒ«ï¼‰
        const initStart = confEntry?.start
          ? toTimeInput(confEntry.start)
          : (hasReq ? resolveTime(req.start, OPEN_TIME)  : '');
        const initEnd   = confEntry?.end
          ? toTimeInput(confEntry.end)
          : (hasReq ? resolveTime(req.end,   CLOSE_TIME) : '');

        const dayOffCls = isDayOff ? ' day-off' : '';
        const dayOffLabel = isDayOff ? '<span class="day-off-label">ä¼‘</span>' : '';
        html += `<td class="${cc}">
          <div class="${cellCls}${dayOffCls}" data-staff="${name}" data-day="${d.day}" data-has-req="${hasReq ? '1' : ''}" data-day-off="${isDayOff ? '1' : ''}">
            <button class="btn-day-off" data-staff="${name}" data-day="${d.day}" title="${isDayOff ? 'ä¼‘ã¿ã‚’è§£é™¤' : 'ä¼‘ã¿ã«ã™ã‚‹'}">${isDayOff ? 'è§£é™¤' : 'ä¼‘'}</button>
            ${dayOffLabel}
            ${reqLabel}
            <div class="shift-time-inputs">
              <input type="time" class="conf-start" data-staff="${name}" data-day="${d.day}" value="${initStart}" placeholder="å‡ºå‹¤">
              <input type="time" class="conf-end"   data-staff="${name}" data-day="${d.day}" value="${initEnd}"   placeholder="é€€å‹¤">
            </div>
          </div>
        </td>`;
      });

      html += '</tr>';
    });

    // ===== äººæ•°ãƒã‚§ãƒƒã‚¯è¡Œ =====
    const requiredWd = settings.requiredStaff   || 0;
    const requiredWe = settings.requiredStaffWe || requiredWd; // åœŸæ—¥æœªè¨­å®šãªã‚‰å¹³æ—¥ã¨åŒã˜
    html += '<tr class="hc-row">';
    html += `<td class="hc-label">ç¢ºå®šäººæ•°<br><small style="font-weight:normal;">å¹³æ—¥:${requiredWd}äºº åœŸæ—¥:${requiredWe}äºº</small></td>`;
    days.forEach(d => {
      const cc = colClass(d);
      const isWE = d.isSaturday || d.isSunday || d.isHoliday;
      const required = isWE ? requiredWe : requiredWd;
      const confCount = (confirmed[d.day] ?? []).filter(e => !e.dayOff).length;
      const { icon, color } = headcountStatus(confCount, required);
      html += `<td id="hc-${d.day}" class="${cc}" style="color:${color};text-align:center;">${icon}<br><small>${confCount}/${required}</small></td>`;
    });
    html += '</tr>';

    html += '</tbody>';
    table.innerHTML = html;

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² =====

    // ã€Œä¼‘ã€ãƒœã‚¿ãƒ³
    table.querySelectorAll('.btn-day-off').forEach(btn => {
      btn.addEventListener('click', () => {
        const day   = btn.dataset.day;
        const staff = btn.dataset.staff;
        const cell  = btn.closest('.shift-cell');
        const isDayOff = cell.dataset.dayOff === '1';

        if (isDayOff) {
          // ä¼‘ã¿è§£é™¤ â†’ ã‚¨ãƒ³ãƒˆãƒªå‰Šé™¤
          this.saveConfirmedEntry(month, day, staff, '', '', false);
          cell.classList.remove('day-off');
          cell.dataset.dayOff = '0';
          btn.textContent = 'ä¼‘';
          btn.title = 'ä¼‘ã¿ã«ã™ã‚‹';
          const lbl = cell.querySelector('.day-off-label');
          if (lbl) lbl.remove();
          cell.querySelector('.shift-time-inputs').style.display = '';
          const rl = cell.querySelector('.shift-request-label');
          if (rl) rl.style.display = '';
          // has-request ã‚¯ãƒ©ã‚¹å†é©ç”¨
          if (cell.dataset.hasReq === '1') cell.classList.add('has-request');
        } else {
          // ä¼‘ã¿ã«ã™ã‚‹ â†’ æ™‚é–“ã‚¯ãƒªã‚¢ + day-off ãƒ•ãƒ©ã‚°ä¿å­˜
          cell.querySelector('.conf-start').value = '';
          cell.querySelector('.conf-end').value   = '';
          this.saveConfirmedEntry(month, day, staff, '', '', true);
          cell.classList.remove('confirmed', 'has-request');
          cell.classList.add('day-off');
          cell.dataset.dayOff = '1';
          btn.textContent = 'è§£é™¤';
          btn.title = 'ä¼‘ã¿ã‚’è§£é™¤';
          // ã€Œä¼‘ã€ãƒ©ãƒ™ãƒ«ã‚’æŒ¿å…¥ï¼ˆã¾ã ãªã„å ´åˆï¼‰
          if (!cell.querySelector('.day-off-label')) {
            const lbl = document.createElement('span');
            lbl.className = 'day-off-label';
            lbl.textContent = 'ä¼‘';
            btn.insertAdjacentElement('afterend', lbl);
          }
          cell.querySelector('.shift-time-inputs').style.display = 'none';
          const rl = cell.querySelector('.shift-request-label');
          if (rl) rl.style.display = 'none';
        }
      });
    });

    table.querySelectorAll('input.conf-start, input.conf-end').forEach(inp => {
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚: ã‚»ãƒ«å…¨ä½“ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      inp.addEventListener('focus', () => {
        inp.closest('.shift-cell').style.outline = '2px solid var(--color-primary)';
      });
      inp.addEventListener('blur', () => {
        inp.closest('.shift-cell').style.outline = '';
      });
      // å€¤å¤‰æ›´æ™‚: ä¿å­˜ + ã‚»ãƒ«çŠ¶æ…‹æ›´æ–°
      inp.addEventListener('change', () => {
        const day   = inp.dataset.day;
        const staff = inp.dataset.staff;
        const cell  = inp.closest('.shift-cell');
        const startVal = cell.querySelector('.conf-start').value;
        const endVal   = cell.querySelector('.conf-end').value;
        this.saveConfirmedEntry(month, day, staff, startVal, endVal, false);
        // ã‚»ãƒ«ã®è‰²ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        const isConf = !!(startVal || endVal);
        cell.className = 'shift-cell' + (isConf ? ' confirmed' : (cell.dataset.hasReq === '1' ? ' has-request' : ''));
      });
    });
  },

  saveConfirmedEntry(month, day, staffName, start, end, dayOff = false) {
    if (!AppState.confirmed[month]) AppState.confirmed[month] = {};
    if (!AppState.confirmed[month][day]) AppState.confirmed[month][day] = [];

    const list = AppState.confirmed[month][day];
    const idx = list.findIndex(e => e.staffName === staffName);
    if (dayOff) {
      // ä¼‘ã¿ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆï¼ˆæ™‚é–“ã¯ã‚¯ãƒªã‚¢ï¼‰
      const entry = { staffName, start: '', end: '', dayOff: true };
      if (idx >= 0) list[idx] = entry; else list.push(entry);
    } else if (start || end) {
      const entry = { staffName, start: toStoredTime(start), end: toStoredTime(end), dayOff: false };
      if (idx >= 0) list[idx] = entry; else list.push(entry);
    } else {
      if (idx >= 0) list.splice(idx, 1);
    }
    AppState.saveConfirmed(month);

    // äººæ•°ã‚»ãƒ«æ›´æ–°ï¼ˆä¼‘ã¿ã¯äººæ•°ã«å«ã‚ãªã„ï¼‰
    const settings = AppState.settings[month] ?? {};
    const confCount = (AppState.confirmed[month][day] ?? []).filter(e => !e.dayOff).length;
    const dayObj = Utils.getDaysInMonth(month).find(d => String(d.day) === String(day));
    const isWE = dayObj && (dayObj.isSaturday || dayObj.isSunday || dayObj.isHoliday);
    const requiredWd = settings.requiredStaff   || 0;
    const requiredWe = settings.requiredStaffWe || requiredWd;
    const required = isWE ? requiredWe : requiredWd;
    const { icon, color } = headcountStatus(confCount, required);
    const hcCell = document.getElementById(`hc-${day}`);
    if (hcCell) { hcCell.style.color = color; hcCell.innerHTML = `${icon}<br><small>${confCount}/${required}</small>`; }

    this.buildAnalysis(month);
    AlertModule.checkOverages(month);
  },

  calcDailyTotalHours(day, month) {
    const confDay = AppState.confirmed[month]?.[day] ?? [];
    let total = 0;
    confDay.forEach(e => {
      const h = Utils.calcWorkHours(e.start, e.end);
      if (h !== null) total += h;
    });
    return total;
  },

  buildAnalysis(month) {
    const container = document.getElementById('analysis-content');
    const s = AppState.settings[month] ?? {};
    const days = Utils.getDaysInMonth(month);

    if (!s.budget) {
      container.innerHTML = '<p style="color:var(--color-muted);">æœˆã®äººä»¶è²»äºˆç®—ã‚’è¨­å®šãƒ»ä¿å­˜ã™ã‚‹ã¨è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</p>';
      return;
    }

    // â”€â”€ åŸºç¤è¨ˆç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // åç°¿ã‹ã‚‰å¹³å‡æ™‚çµ¦ã‚’è‡ªå‹•è¨ˆç®—
    const wages   = AppState.roster.map(st => st.wage).filter(w => w && w > 0);
    const avgWage = wages.length ? Math.round(wages.reduce((a,b)=>a+b,0) / wages.length) : 0;

    // å¹³æ—¥ãƒ»åœŸæ—¥åˆ†é¡
    const weekdays = days.filter(d => !d.isSaturday && !d.isSunday && !d.isHoliday);
    const weekends = days.filter(d =>  d.isSaturday ||  d.isSunday ||  d.isHoliday);

    const reqWd = s.requiredStaff   || 0;
    const reqWe = s.requiredStaffWe || reqWd;

    // æ›œæ—¥åˆ¥å–¶æ¥­æ™‚é–“ã‚’è€ƒæ…®ã—ãŸæ—¥åˆ¥ç·æ™‚é–“ã‚’ç©ç®—
    const totalHoursWd = weekdays.reduce((sum, d) => sum + getDayOperatingHours(d.dateStr, s).hours * reqWd, 0);
    const totalHoursWe = weekends.reduce((sum, d)  => sum + getDayOperatingHours(d.dateStr, s).hours * reqWe, 0);
    const totalHoursAll = totalHoursWd + totalHoursWe;
    const dailyBudgetWd = weekdays.length ? s.budget * (totalHoursAll ? totalHoursWd / totalHoursAll : weekdays.length / days.length) / weekdays.length : 0;
    const dailyBudgetWe = weekends.length ? s.budget * (totalHoursAll ? totalHoursWe / totalHoursAll : weekends.length / days.length) / weekends.length : 0;

    // æœˆã®ç·åŠ´åƒå¯èƒ½æ™‚é–“ï¼ˆå¹³å‡æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ï¼‰
    const totalLaborHours = avgWage ? s.budget / avgWage : 0;

    // ã‚µãƒãƒªãƒ¼ç”¨ï¼šå¹³æ—¥ãƒ»åœŸæ—¥ãã‚Œãã‚Œã®å¹³å‡å–¶æ¥­æ™‚é–“ã‚’ä»£è¡¨å€¤ã¨ã—ã¦ä½¿ç”¨
    const avgWdOpH = weekdays.length ? weekdays.reduce((sum,d) => sum + getDayOperatingHours(d.dateStr,s).hours, 0) / weekdays.length : 0;
    const avgWeOpH = weekends.length  ? weekends.reduce((sum,d)  => sum + getDayOperatingHours(d.dateStr,s).hours, 0) / weekends.length : 0;
    // ç›®æ¨™äººæ™‚ç”Ÿç”£æ€§ = 1æ—¥ã®äººä»¶è²»ä¸Šé™ Ã· (å¿…è¦äººæ•° Ã— å¹³å‡å–¶æ¥­æ™‚é–“)
    const wdProdPerH = (reqWd && avgWdOpH) ? Math.round(dailyBudgetWd / (reqWd * avgWdOpH)) : 0;
    const weProdPerH = (reqWe && avgWeOpH) ? Math.round(dailyBudgetWe / (reqWe * avgWeOpH)) : 0;

    // â”€â”€ ã‚µãƒãƒªãƒ¼è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let html = `
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px;">
      ${avgWage ? `<div style="background:#F0FDF4;border:1px solid #6EE7B7;border-radius:8px;padding:10px 16px;min-width:160px;">
        <div style="font-size:11px;color:#065F46;">åç°¿ã®å¹³å‡æ™‚çµ¦</div>
        <div style="font-size:20px;font-weight:700;color:#065F46;">${avgWage.toLocaleString()}å††</div>
      </div>` : ''}
      ${totalLaborHours ? `<div style="background:#EFF6FF;border:1px solid #93C5FD;border-radius:8px;padding:10px 16px;min-width:160px;">
        <div style="font-size:11px;color:#1E40AF;">æœˆã®ç·åŠ´åƒå¯èƒ½æ™‚é–“</div>
        <div style="font-size:20px;font-weight:700;color:#1E40AF;">${totalLaborHours.toFixed(1)} h</div>
        <div style="font-size:10px;color:#6B7280;">äºˆç®— Ã· å¹³å‡æ™‚çµ¦</div>
      </div>` : ''}
      ${wdProdPerH ? `<div style="background:#FFFBEB;border:1px solid #FCD34D;border-radius:8px;padding:10px 16px;min-width:160px;">
        <div style="font-size:11px;color:#92400E;">å¹³æ—¥ ç›®æ¨™äººæ™‚ç”Ÿç”£æ€§</div>
        <div style="font-size:20px;font-weight:700;color:#92400E;">${wdProdPerH.toLocaleString()}å††/h</div>
        <div style="font-size:10px;color:#6B7280;">1äºº1æ™‚é–“ã‚ãŸã‚Šã®ç›®æ¨™å£²ä¸Š</div>
      </div>` : ''}
      ${weProdPerH ? `<div style="background:#FDF4FF;border:1px solid #D8B4FE;border-radius:8px;padding:10px 16px;min-width:160px;">
        <div style="font-size:11px;color:#6B21A8;">åœŸæ—¥ç¥ ç›®æ¨™äººæ™‚ç”Ÿç”£æ€§</div>
        <div style="font-size:20px;font-weight:700;color:#6B21A8;">${weProdPerH.toLocaleString()}å††/h</div>
        <div style="font-size:10px;color:#6B7280;">1äºº1æ™‚é–“ã‚ãŸã‚Šã®ç›®æ¨™å£²ä¸Š</div>
      </div>` : ''}
    </div>`;

    // â”€â”€ æ—¥åˆ¥åˆ†æãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    html += `<h4 style="margin-bottom:8px;font-size:13px;">ğŸ“… æ—¥åˆ¥ åˆ†æ</h4>
      <div style="overflow-x:auto;"><table style="min-width:560px;font-size:12px;">
      <thead><tr>
        <th>æ—¥ä»˜</th><th>æ›œ</th>
        <th style="text-align:right">ç¢ºå®šäººæ•°</th>
        <th style="text-align:right">ç¢ºå®š åŠ´åƒæ™‚é–“</th>
        <th style="text-align:right">1äººã‚ãŸã‚Šç›®æ¨™å£²ä¸Š</th>
        <th style="text-align:right">1h ã‚ãŸã‚Šç›®æ¨™å£²ä¸Š</th>
        <th style="text-align:right">äººä»¶è²»ä¸Šé™</th>
      </tr></thead><tbody>`;

    days.forEach(d => {
      const totalH  = this.calcDailyTotalHours(d.day, month);
      const confCnt = (AppState.confirmed[month]?.[d.day] ?? []).filter(e => !e.dayOff).length;
      const isWE    = d.isSaturday || d.isSunday || d.isHoliday;
      const limit   = isWE ? dailyBudgetWe : dailyBudgetWd;
      const { hours: dayOpH } = getDayOperatingHours(d.dateStr, s);
      const reqDay  = isWE ? reqWe : reqWd;
      // 1æ—¥ã®äººæ™‚ç”Ÿç”£æ€§ç›®æ¨™ = äººä»¶è²»ä¸Šé™ Ã· (å¿…è¦äººæ•° Ã— ãã®æ—¥ã®å–¶æ¥­æ™‚é–“)
      const prodH   = (reqDay && dayOpH) ? Math.round(limit / (reqDay * dayOpH)) : 0;

      // 1æ—¥ã®ç›®æ¨™å£²ä¸Š = äººæ™‚ç”Ÿç”£æ€§ Ã— ç¢ºå®šç·åŠ´åƒæ™‚é–“
      const dayTarget = (prodH && totalH) ? prodH * totalH : null;
      // 1äººã‚ãŸã‚Šç›®æ¨™å£²ä¸Š = æ—¥ã®ç›®æ¨™å£²ä¸Š Ã· ç¢ºå®šäººæ•°
      const perStaff  = (dayTarget && confCnt) ? Math.round(dayTarget / confCnt) : null;

      const rowClass = (d.isHoliday || d.isSunday) ? 'day-holiday' : d.isSaturday ? 'day-saturday' : '';
      html += `<tr class="${rowClass}">
        <td>${d.day}æ—¥</td>
        <td>${d.dayName}</td>
        <td style="text-align:right;">${confCnt > 0 ? confCnt + 'äºº' : 'â€”'}</td>
        <td style="text-align:right;">${totalH  > 0 ? totalH.toFixed(1) + ' h' : 'â€”'}</td>
        <td style="text-align:right;font-weight:600;">${perStaff  ? Utils.formatYen(perStaff)  : 'â€”'}</td>
        <td style="text-align:right;font-weight:600;">${dayTarget ? Utils.formatYen(Math.round(dayTarget / (totalH||1))) : 'â€”'}</td>
        <td style="text-align:right;">${Utils.formatYen(limit)}</td>
      </tr>`;
    });
    html += '</tbody></table></div>';

    container.innerHTML = html;
  }
};

// ============================================================
// AlertModule
// ============================================================
const AlertModule = {
  checkOverages(month) {
    if (!month) return;
    const messages = [];
    // å…¨ã‚¹ã‚¿ãƒƒãƒ•åã‚»ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆç¸¦=ã‚¹ã‚¿ãƒƒãƒ•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ + æ—§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆäº’æ›ï¼‰
    document.querySelectorAll('.cal-staff-name, .staff-header').forEach(el => {
      el.classList.remove('monthly-overage','weekly-overage');
    });

    AppState.roster.forEach(staff => {
      // æœˆã‚ªãƒ¼ãƒãƒ¼
      const monthlyTotal = this.calcMonthlyHours(staff.name, month);
      if (staff.monthlyHours && monthlyTotal > staff.monthlyHours) {
        const over = (monthlyTotal - staff.monthlyHours).toFixed(1);
        messages.push(`${staff.name}ã•ã‚“ãŒæœˆå¥‘ç´„æ™‚é–“ã‚’${over}æ™‚é–“è¶…éã—ã¦ã„ã¾ã™`);
        this.highlightStaff(staff.name, 'monthly-overage');
      }

      // é€±ã‚ªãƒ¼ãƒãƒ¼
      const weekMap = this.calcWeeklyHours(staff.name, month);
      Object.entries(weekMap).forEach(([weekKey, hours]) => {
        if (staff.weeklyHours && hours > staff.weeklyHours) {
          const over = (hours - staff.weeklyHours).toFixed(1);
          messages.push(`${staff.name}ã•ã‚“ãŒ${weekKey}ã®é€±å¥‘ç´„æ™‚é–“ã‚’${over}æ™‚é–“è¶…éã—ã¦ã„ã¾ã™`);
          this.highlightStaff(staff.name, 'weekly-overage');
        }
      });
    });

    const banner = document.getElementById('alert-banner');
    if (messages.length === 0) {
      banner.classList.add('hidden');
    } else {
      banner.innerHTML = 'âš ï¸ ' + messages.join(' ï¼ ');
      banner.classList.remove('hidden');
    }
  },

  calcMonthlyHours(staffName, month) {
    const confirmed = AppState.confirmed[month] ?? {};
    let total = 0;
    Object.values(confirmed).forEach(list => {
      const entry = list.find(e => e.staffName === staffName);
      if (entry) {
        const h = Utils.calcWorkHours(entry.start, entry.end);
        if (h !== null) total += h;
      }
    });
    return total;
  },

  calcWeeklyHours(staffName, month) {
    const confirmed = AppState.confirmed[month] ?? {};
    const weekMap = {};
    Object.entries(confirmed).forEach(([dayStr, list]) => {
      const entry = list.find(e => e.staffName === staffName);
      if (entry) {
        const pad = String(dayStr).padStart(2,'0');
        const dateStr = `${month}-${pad}`;
        const weekKey = Utils.getISOWeekKey(dateStr);
        const h = Utils.calcWorkHours(entry.start, entry.end);
        if (h !== null) weekMap[weekKey] = (weekMap[weekKey] ?? 0) + h;
      }
    });
    return weekMap;
  },

  highlightStaff(name, cls) {
    // æ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆç¸¦=ã‚¹ã‚¿ãƒƒãƒ•ï¼‰ã§ã¯ .cal-staff-name ã‚’ä½¿ç”¨
    document.querySelectorAll(`.cal-staff-name[data-staff="${name}"]`).forEach(el => {
      el.classList.add(cls);
    });
    // æ—§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆäº’æ›
    document.querySelectorAll(`.staff-header[data-staff="${name}"]`).forEach(el => {
      el.classList.add(cls);
    });
  }
};

// ============================================================
// ExportModule
// ============================================================
const ExportModule = {
  exportToExcel(month) {
    if (typeof XLSX === 'undefined') {
      alert('SheetJSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    const confirmed = AppState.confirmed[month] ?? {};
    const days      = Utils.getDaysInMonth(month);
    const s         = AppState.settings[month] ?? {};

    // ç›®æ¨™äººæ™‚ç”Ÿç”£æ€§ã‚’å†è¨ˆç®—ï¼ˆbuildAnalysis ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ãƒ»æ›œæ—¥åˆ¥å¯¾å¿œï¼‰
    const wages     = AppState.roster.map(st => st.wage).filter(w => w && w > 0);
    const avgWage   = wages.length ? Math.round(wages.reduce((a,b)=>a+b,0)/wages.length) : 0;
    const reqWd     = s.requiredStaff   || 0;
    const reqWe     = s.requiredStaffWe || reqWd;
    const weekdays  = days.filter(d => !d.isSaturday && !d.isSunday && !d.isHoliday);
    const weekends  = days.filter(d =>  d.isSaturday ||  d.isSunday ||  d.isHoliday);
    const totalHWd  = weekdays.reduce((sum, d) => sum + getDayOperatingHours(d.dateStr, s).hours * reqWd, 0);
    const totalHWe  = weekends.reduce((sum, d)  => sum + getDayOperatingHours(d.dateStr, s).hours * reqWe, 0);
    const totalHAll = totalHWd + totalHWe;
    const dailyBudWd = weekdays.length ? s.budget * (totalHAll ? totalHWd/totalHAll : weekdays.length/days.length) / weekdays.length : 0;
    const dailyBudWe = weekends.length ? s.budget * (totalHAll ? totalHWe/totalHAll : weekends.length/days.length) / weekends.length : 0;

    const rows = [
      ['æ—¥ä»˜','æ›œæ—¥','ã‚¹ã‚¿ãƒƒãƒ•å','ç¢ºå®šå‡ºå‹¤','ç¢ºå®šé€€å‹¤','åŠ´åƒæ™‚é–“ï¼ˆhï¼‰','ç¢ºå®šäººæ•°','1äººã‚ãŸã‚Šç›®æ¨™å£²ä¸Š','1hã‚ãŸã‚Šç›®æ¨™å£²ä¸Š','äººä»¶è²»ä¸Šé™']
    ];

    days.forEach(d => {
      const confDay   = (confirmed[d.day] ?? []).filter(e => !e.dayOff);
      const allDay    = confirmed[d.day] ?? [];
      const headcount = confDay.length;
      const isWE      = d.isSaturday || d.isSunday || d.isHoliday;
      const { hours: dayOpH } = getDayOperatingHours(d.dateStr, s);
      const reqDay    = isWE ? reqWe : reqWd;
      const limit     = isWE ? dailyBudWe : dailyBudWd;
      // æ—¥åˆ¥ã®äººæ™‚ç”Ÿç”£æ€§ç›®æ¨™ = 1æ—¥ã®äººä»¶è²»ä¸Šé™ Ã· (å¿…è¦äººæ•° Ã— ãã®æ—¥ã®å–¶æ¥­æ™‚é–“)
      const prodH     = (reqDay && dayOpH) ? Math.round(limit / (reqDay * dayOpH)) : 0;

      // æ—¥ã®ç¢ºå®šç·åŠ´åƒæ™‚é–“
      let dayTotalH = 0;
      confDay.forEach(e => { const h = Utils.calcWorkHours(e.start, e.end); if (h) dayTotalH += h; });
      const dayTarget   = (prodH && dayTotalH) ? prodH * dayTotalH : null;
      const perStaff    = (dayTarget && headcount) ? Math.round(dayTarget / headcount) : null;
      const perHourSale = (dayTarget && dayTotalH) ? Math.round(dayTarget / dayTotalH) : null;

      if (allDay.length === 0) {
        // ã‚·ãƒ•ãƒˆãªã—è¡Œ
        rows.push([d.dateStr, d.dayName, '', '', '', '', 0, perStaff ?? '', perHourSale ?? '', limit ? Math.round(limit) : '']);
      } else {
        allDay.forEach((entry, i) => {
          const h = entry.dayOff ? null : Utils.calcWorkHours(entry.start, entry.end);
          rows.push([
            d.dateStr,
            d.dayName,
            entry.staffName + (entry.dayOff ? 'ï¼ˆä¼‘ï¼‰' : ''),
            entry.dayOff ? 'ä¼‘' : (entry.start || ''),
            entry.dayOff ? 'ä¼‘' : (entry.end   || ''),
            entry.dayOff ? '' : (h !== null ? +h.toFixed(2) : ''),
            i === 0 ? headcount : '',           // ç¢ºå®šäººæ•°ã¯å…ˆé ­è¡Œã®ã¿
            i === 0 ? (perStaff    ?? '') : '', // 1äººã‚ãŸã‚Šç›®æ¨™å£²ä¸Šã‚‚å…ˆé ­è¡Œã®ã¿
            i === 0 ? (perHourSale ?? '') : '', // 1hã‚ãŸã‚Šç›®æ¨™å£²ä¸Šã‚‚å…ˆé ­è¡Œã®ã¿
            i === 0 ? (limit ? Math.round(limit) : '') : ''
          ]);
        });
      }
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [
      {wch:14},{wch:5},{wch:16},{wch:10},{wch:10},{wch:12},{wch:8},{wch:16},{wch:16},{wch:12}
    ];
    ws['!freeze'] = { xSplit: 0, ySplit: 1 };

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, `${month}ç¢ºå®šã‚·ãƒ•ãƒˆ`);
    XLSX.writeFile(wb, `shift_${month}.xlsx`);
    Utils.showToast('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
  }
};

// ============================================================
// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
// ============================================================
function formatTime(val) {
  if (!val) return 'â€”';
  if (val === 'any') return '09:00'; // ã„ã¤ã‹ã‚‰ã§ã‚‚ â†’ æœ€æ—©æ™‚é–“
  return val;
}

function toTimeInput(val) {
  if (!val) return '';
  if (val === 'any') return ''; // ãƒ—ãƒªãƒ•ã‚£ãƒ«ã¯ resolveTime å´ã§å‡¦ç†
  return val;
}

function toStoredTime(val) {
  return val || '';
}

// æ›œæ—¥ç•ªå·ï¼ˆ0=æ—¥,1=æœˆ...6=åœŸï¼‰â†’ dayHoursã‚­ãƒ¼
const DOW_KEYS = ['sun','mon','tue','wed','thu','fri','sat'];

// è¨­å®šã‹ã‚‰ãã®æ—¥ã®å–¶æ¥­æ™‚é–“ï¼ˆhï¼‰ã‚’è¿”ã™
function getDayOperatingHours(dateStr, s) {
  const date = new Date(dateStr + 'T00:00:00');
  const dow  = date.getDay(); // 0=æ—¥
  const key  = DOW_KEYS[dow];
  // å®šä¼‘æ—¥ãƒã‚§ãƒƒã‚¯
  const closedKey = 'closed_' + key;
  if (s.dayHours?.[closedKey] !== undefined) {
    return { openH: 0, closeH: 0, hours: 0, openT: null, closeT: null, isClosed: true };
  }
  const dh   = s.dayHours?.[key];
  const openT  = dh?.open  || s.openTime  || '09:00';
  const closeT = dh?.close || s.closeTime || '22:00';
  const openH  = +openT.split(':')[0]  + +openT.split(':')[1]  / 60;
  const closeH = +closeT.split(':')[0] + +closeT.split(':')[1] / 60;
  return { openH, closeH, hours: Math.max(closeH - openH, 1), openT, closeT, isClosed: false };
}

function headcountStatus(count, required) {
  if (required <= 0) return { icon: 'â€”', color: '#9CA3AF' };
  if (count > required) return { icon: 'ğŸ”´', color: '#FF4D6D' };
  if (count < required) return { icon: 'ğŸ”µ', color: '#4DABF7' };
  return { icon: 'ğŸŸ¢', color: '#51CF66' };
}

// ============================================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// ============================================================
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(`panel-${btn.dataset.tab}`).classList.add('active');

    if (btn.dataset.tab === 'dashboard') {
      const m = document.getElementById('dashboard-month').value;
      if (m) DashboardModule.render(m);
    }
  });
});

// ============================================================
// EventBus ãƒ¯ã‚¤ãƒ¤ãƒªãƒ³ã‚°
// ============================================================
EventBus.on('rosterChanged', () => {
  RosterModule.render();
  RosterModule.populateDropdowns();
  const m = AppState.currentDashMonth;
  if (m) AlertModule.checkOverages(m);
});

EventBus.on('requestSaved', ({ month }) => {
  if (AppState.currentDashMonth === month) {
    DashboardModule.buildCalendar(month);
    DashboardModule.buildAnalysis(month);
  }
});

// ============================================================
// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
// ============================================================

// ã‚¹ã‚¿ãƒƒãƒ•åç°¿ãƒ•ã‚©ãƒ¼ãƒ 
document.getElementById('roster-form').addEventListener('submit', e => RosterModule.save(e));
document.getElementById('roster-clear-btn').addEventListener('click', () => RosterModule.clearForm());
document.getElementById('wage-toggle-btn').addEventListener('click', () => RosterModule.toggleWageVisibility());

// ã‚·ãƒ•ãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå‰åŠï¼‰
document.getElementById('target-month-first').addEventListener('change', e => {
  const m = e.target.value;
  if (m && !AppState.requests[m]) AppState.loadMonth(m);
  FormModule.buildTable('first', m);
});
document.getElementById('staff-select-first').addEventListener('change', () => {
  const m = document.getElementById('target-month-first').value;
  FormModule.buildTable('first', m);
});
document.getElementById('form-submit-first').addEventListener('click', () => FormModule.submit('first'));
document.getElementById('form-clear-first').addEventListener('click', () => FormModule.clearForm('first'));

// ã‚·ãƒ•ãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå¾ŒåŠï¼‰
document.getElementById('target-month-second').addEventListener('change', e => {
  const m = e.target.value;
  if (m && !AppState.requests[m]) AppState.loadMonth(m);
  FormModule.buildTable('second', m);
});
document.getElementById('staff-select-second').addEventListener('change', () => {
  const m = document.getElementById('target-month-second').value;
  FormModule.buildTable('second', m);
});
document.getElementById('form-submit-second').addEventListener('click', () => FormModule.submit('second'));
document.getElementById('form-clear-second').addEventListener('click', () => FormModule.clearForm('second'));

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ å¯¾è±¡æœˆ
document.getElementById('dashboard-month').addEventListener('change', e => {
  const m = e.target.value;
  AppState.currentDashMonth = m;
  if (m) {
    AppState.loadMonth(m);
    DashboardModule.render(m);
  }
});

// æ›œæ—¥åˆ¥ã€Œï¼‹è¿½åŠ ã€ãƒœã‚¿ãƒ³
document.getElementById('s-add-day-hours-btn').addEventListener('click', () => {
  const sel = document.getElementById('s-add-day-group');
  const key = sel.value;
  if (!key) { alert('è¿½åŠ ã™ã‚‹æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  // æ—¢ã«è¿½åŠ æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
  const exists = [...document.querySelectorAll('#day-hours-list .day-hours-row')].some(r => r.dataset.key === key);
  if (exists) { alert('ãã®æ›œæ—¥ã¯ã™ã§ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™'); return; }
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚é–“ã‚’åˆæœŸå€¤ã«ã‚»ãƒƒãƒˆ
  const openDefault  = document.getElementById('s-open-time').value  || '09:00';
  const closeDefault = document.getElementById('s-close-time').value || '22:00';
  DashboardModule._appendDayHoursRow(key, openDefault, closeDefault);
  DashboardModule._updateAddSelect();
  sel.value = ''; // é¸æŠãƒªã‚»ãƒƒãƒˆ
});

// è¨­å®šä¿å­˜
document.getElementById('save-settings-btn').addEventListener('click', () => {
  const m = document.getElementById('dashboard-month').value;
  if (!m) { alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  DashboardModule.saveSettings(m);
});

// Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
document.getElementById('export-excel-btn').addEventListener('click', () => {
  const m = document.getElementById('dashboard-month').value;
  if (!m) { alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  ExportModule.exportToExcel(m);
});

// ============================================================
// GASé€£æºãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
// ============================================================
const GasModule = {
  getUrl() {
    return localStorage.getItem('gas_url') ?? '';
  },
  saveUrl(url) {
    localStorage.setItem('gas_url', url);
  },

  setStatus(msg, type) {
    const el = document.getElementById('gas-status');
    const colors = { ok: '#065F46', error: '#B91C1C', loading: '#1E40AF' };
    const bg = { ok: '#ECFDF5', error: '#FEE2E2', loading: '#EFF6FF' };
    el.style.cssText = `color:${colors[type]};background:${bg[type]};padding:6px 10px;border-radius:6px;`;
    el.textContent = msg;
  },

  // GASã‹ã‚‰ã‚·ãƒ•ãƒˆå¸Œæœ›ãƒ‡ãƒ¼ã‚¿ã¨åç°¿ã‚’å–å¾—ã—ã¦localStorageã«åæ˜ 
  async syncFromGas(month) {
    const url = this.getUrl();
    if (!url) {
      this.setStatus('âš ï¸ GAS URLã‚’å…¥åŠ›ãƒ»ä¿å­˜ã—ã¦ãã ã•ã„', 'error');
      return;
    }
    if (!month) {
      this.setStatus('âš ï¸ å…ˆã«å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      return;
    }

    this.setStatus('â³ GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...', 'loading');
    document.getElementById('sync-gas-btn').disabled = true;

    try {
      // ã‚·ãƒ•ãƒˆå¸Œæœ›ãƒ‡ãƒ¼ã‚¿å–å¾—
      const reqUrl = `${url}?action=getData&month=${encodeURIComponent(month)}`;
      const res = await fetch(reqUrl);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();

      if (json.status !== 'ok') throw new Error(json.message ?? 'å–å¾—å¤±æ•—');

      const { requests, staffList } = json.data;

      // localStorageã«åæ˜ ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ï¼‰
      if (!AppState.requests[month]) AppState.requests[month] = {};
      Object.entries(requests).forEach(([staffName, days]) => {
        AppState.requests[month][staffName] = days;
      });
      AppState.saveRequests(month);

      // ã‚¹ã‚¿ãƒƒãƒ•åç°¿ã‚‚åŒæœŸï¼ˆåç°¿ã«å­˜åœ¨ã—ãªã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ï¼‰
      await this.syncStaff(url);

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å†æç”»
      DashboardModule.buildCalendar(month);
      DashboardModule.buildAnalysis(month);
      AlertModule.checkOverages(month);

      const count = Object.keys(requests).length;
      this.setStatus(`âœ… ${count}ååˆ†ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼ˆ${month}ï¼‰`, 'ok');
      Utils.showToast('GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');

    } catch (err) {
      this.setStatus(`âŒ å–å¾—å¤±æ•—ï¼š${err.message}ã€€â€»CORSè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„`, 'error');
    } finally {
      document.getElementById('sync-gas-btn').disabled = false;
    }
  },

  async syncStaff(url) {
    try {
      const res = await fetch(`${url}?action=getStaff`);
      const json = await res.json();
      if (json.status !== 'ok') return;

      // GASã®ã‚¹ã‚¿ãƒƒãƒ•åç°¿ã‚’æ­£ã¨ã—ã¦æ¯å›å®Œå…¨ä¸Šæ›¸ã
      // æ˜‡çµ¦ãƒ»é›‡ç”¨å½¢æ…‹å¤‰æ›´ãªã©ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå´ã®å¤‰æ›´ã‚’å¸¸ã«åæ˜ ã™ã‚‹
      AppState.roster = json.staffList.map(gasStaff => {
        const existing = AppState.roster.find(s => s.name === gasStaff.name);
        const isSeishain = (gasStaff.employmentType === 'æ­£ç¤¾å“¡') ||
                           (existing && existing.employmentType === 'æ­£ç¤¾å“¡');

        if (isSeishain) {
          // æ­£ç¤¾å“¡ã¯GASã‹ã‚‰ã®çµ¦ä¸æƒ…å ±ã‚’ä½¿ã‚ãšlocalStorageã®å€¤ã‚’ç¶­æŒ
          return {
            id:             existing ? existing.id : Utils.uid(),
            name:           gasStaff.name,
            employmentType: existing?.employmentType || gasStaff.employmentType || 'æ­£ç¤¾å“¡',
            weeklyHours:    existing?.weeklyHours    ?? gasStaff.weeklyHours    ?? null,
            monthlyHours:   existing?.monthlyHours   ?? gasStaff.monthlyHours   ?? null,
            // çµ¦ä¸æƒ…å ±ã¯localStorageã‚’å„ªå…ˆ
            baseSalary:     existing?.baseSalary     ?? null,
            legalHours:     existing?.legalHours     ?? 173,
            overtimeHours:  existing?.overtimeHours  ?? 0,
            wage:           existing?.wage           ?? null,
          };
        } else {
          // ãƒ‘ãƒ¼ãƒˆãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆã¯GASã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å€¤ã§æ›´æ–°
          return {
            id:             existing ? existing.id : Utils.uid(),
            name:           gasStaff.name,
            employmentType: gasStaff.employmentType || '',
            weeklyHours:    gasStaff.weeklyHours    ?? null,
            monthlyHours:   gasStaff.monthlyHours   ?? null,
            baseSalary:     null,
            legalHours:     null,
            overtimeHours:  null,
            wage:           gasStaff.wage           ?? null,
          };
        }
      });
      AppState.saveRoster();
      RosterModule.render();
      RosterModule.populateDropdowns();
    } catch (_) { /* åç°¿åŒæœŸã¯å¤±æ•—ã—ã¦ã‚‚OK */ }
  }
};

// ============================================================
// ãƒ•ã‚©ãƒ¼ãƒ URLã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
// ============================================================
const FORM_BASE_URL = 'https://script.google.com/macros/s/AKfycby5ZiS9in11kZ--TtOGKXSBBAZ6a6Rv4fJUlmyJSXXlzo7evmRjyI-DzcqGegGDqkE/exec';

function updateFormUrlPreviews() {
  const month = document.getElementById('dashboard-month').value;
  const firstEl  = document.getElementById('url-preview-first');
  const secondEl = document.getElementById('url-preview-second');
  if (month) {
    firstEl.textContent  = `${FORM_BASE_URL}?month=${month}&half=first`;
    secondEl.textContent = `${FORM_BASE_URL}?month=${month}&half=second`;
  } else {
    firstEl.textContent  = 'â€” å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ â€”';
    secondEl.textContent = 'â€” å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ â€”';
  }
}

function copyFormUrl(half) {
  const month = document.getElementById('dashboard-month').value;
  if (!month) {
    Utils.showToast('âš ï¸ å…ˆã«å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  const fullUrl = `${FORM_BASE_URL}?month=${month}&half=${half}`;
  const halfLabel = half === 'first' ? 'å‰åŠ' : 'å¾ŒåŠ';

  navigator.clipboard.writeText(fullUrl).then(() => {
    Utils.showToast(`âœ… ${month} ${halfLabel}ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
  }).catch(() => {
    window.prompt(`${month} ${halfLabel}ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š`, fullUrl);
  });
}

document.getElementById('copy-url-first-btn').addEventListener('click', () => copyFormUrl('first'));
document.getElementById('copy-url-second-btn').addEventListener('click', () => copyFormUrl('second'));

// å¯¾è±¡æœˆãŒå¤‰ã‚ã£ãŸã‚‰URLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚æ›´æ–°
document.getElementById('dashboard-month').addEventListener('change', updateFormUrlPreviews);

// GAS URL ä¿å­˜ãƒœã‚¿ãƒ³
document.getElementById('save-gas-url-btn').addEventListener('click', () => {
  const url = document.getElementById('gas-url').value.trim();
  if (!url) { GasModule.setStatus('âš ï¸ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
  if (!url.startsWith('https://script.google.com')) {
    GasModule.setStatus('âš ï¸ GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return;
  }
  GasModule.saveUrl(url);
  GasModule.setStatus('âœ… URLã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'ok');
  Utils.showToast('GAS URLã‚’ä¿å­˜ã—ã¾ã—ãŸ');
});

// GASã‹ã‚‰èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
document.getElementById('sync-gas-btn').addEventListener('click', () => {
  const m = document.getElementById('dashboard-month').value;
  GasModule.syncFromGas(m);
});

// ============================================================
// åˆæœŸåŒ–
// ============================================================
(function init() {
  // ä¿å­˜æ¸ˆã¿ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
  const savedAdminPw = localStorage.getItem('admin_password');
  if (savedAdminPw) RosterModule._adminPassword = savedAdminPw;

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒœã‚¿ãƒ³
  document.getElementById('change-password-btn').addEventListener('click', () => {
    const newPw      = document.getElementById('new-password-input').value;
    const confirmPw  = document.getElementById('new-password-confirm').value;
    if (!newPw) { alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (newPw !== confirmPw) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“'); return; }
    RosterModule._adminPassword = newPw;
    localStorage.setItem('admin_password', newPw);
    document.getElementById('new-password-input').value = '';
    document.getElementById('new-password-confirm').value = '';
    alert('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
  });

  RosterModule.render();
  RosterModule.populateDropdowns();
  RosterModule.onEmploymentTypeChange(); // åˆæœŸè¡¨ç¤ºï¼šæ­£ç¤¾å“¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º

  // ä¿å­˜æ¸ˆã¿ã®GAS URLã‚’å¾©å…ƒ
  const savedUrl = GasModule.getUrl();
  if (savedUrl) {
    document.getElementById('gas-url').value = savedUrl;
    document.getElementById('gas-status').textContent = 'âœ… GAS URLãŒè¨­å®šæ¸ˆã¿ã§ã™';
    document.getElementById('gas-status').style.cssText = 'color:#065F46;font-size:12px;';
  }

  // ä»Šæœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®š
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  ['target-month-first','target-month-second','dashboard-month'].forEach(id => {
    document.getElementById(id).value = thisMonth;
  });
  AppState.currentDashMonth = thisMonth;
  AppState.loadMonth(thisMonth);
  FormModule.buildTable('first', thisMonth);
  FormModule.buildTable('second', thisMonth);
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚‚åˆæœŸåŒ–æ™‚ã«æç”»ï¼ˆlocalStorageã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å³è¡¨ç¤ºï¼‰
  DashboardModule.render(thisMonth);
  // ãƒ•ã‚©ãƒ¼ãƒ URLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åˆæœŸåŒ–
  updateFormUrlPreviews();
})();
</script>

<script>
// ãƒ‡ãƒ¢ç”¨åˆæœŸãƒ‡ãƒ¼ã‚¿
(function() {
  // ã™ã§ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (localStorage.getItem('demo_initialized')) return;
  
  // ã‚¹ã‚¿ãƒƒãƒ•åç°¿
  const roster = [
    { name: 'å±±ç”° å¤ªéƒ', employmentType: 'partTime', hourlyWage: 1100, weeklyHours: 20 },
    { name: 'ä½è—¤ èŠ±å­', employmentType: 'partTime', hourlyWage: 1050, weeklyHours: 25 },
    { name: 'éˆ´æœ¨ ä¸€éƒ', employmentType: 'partTime', hourlyWage: 1100, weeklyHours: 15 },
    { name: 'ç”°ä¸­ ç¾å’²', employmentType: 'partTime', hourlyWage: 1050, weeklyHours: 20 },
    { name: 'ä¼Šè—¤ å¥å¤ª', employmentType: 'fullTime', hourlyWage: 1200, weeklyHours: 40 },
  ];
  localStorage.setItem('roster', JSON.stringify(roster));
  localStorage.setItem('demo_initialized', '1');
})();
</script>
</body>
</html>
